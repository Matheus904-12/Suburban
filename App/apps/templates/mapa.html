<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTM Tracker - Rastreamento em Tempo Real</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Modern Icons and Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Modern Futuristic Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);

            --bg-light: #fafbfc;
            --bg-dark: #0f0f23;
            --surface-light: rgba(255, 255, 255, 0.95);
            --surface-dark: rgba(15, 15, 35, 0.95);
            --glass-light: rgba(255, 255, 255, 0.25);
            --glass-dark: rgba(15, 15, 35, 0.25);

            --text-primary-light: #1a1a1a;
            --text-primary-dark: #ffffff;
            --text-secondary-light: #6b7280;
            --text-secondary-dark: #9ca3af;

            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;

            --shadow-light: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-dark: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);

            --border-radius: 24px;
            --border-radius-sm: 16px;
            --border-radius-lg: 32px;

            --transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            --transition-fast: all 0.2s cubic-bezier(0.23, 1, 0.320, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary-light);
            transition: var(--transition);
            overflow-x: hidden;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body.dark {
            background: var(--bg-dark);
            color: var(--text-primary-dark);
        }

        /* ========== FUTURISTIC HEADER ========== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--surface-light);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            transition: var(--transition);
        }

        body.dark .header {
            background: var(--surface-dark);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo i {
            font-size: 28px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--glass-light);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary-light);
            cursor: pointer;
            transition: var(--transition);
            overflow: hidden;
        }

        body.dark .control-btn {
            background: var(--glass-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary-dark);
        }

        .control-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .control-btn:hover::before {
            opacity: 0.1;
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn i {
            position: relative;
            z-index: 1;
            font-size: 18px;
        }

        .theme-toggle {
            background: var(--accent-gradient);
            color: white;
        }

        .theme-toggle::before {
            background: var(--dark-gradient);
        }

        /* ========== MAIN LAYOUT ========== */
        .main-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        /* ========== FUTURISTIC SIDEBAR ========== */
        .sidebar {
            width: 380px;
            background: var(--surface-light);
            backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 24px;
            overflow-y: auto;
            transition: var(--transition);
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) transparent;
        }

        body.dark .sidebar {
            background: var(--surface-dark);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 2px;
        }

        .card {
            background: var(--glass-light);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        body.dark .card {
            background: var(--glass-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-light);
        }

        body.dark .card:hover {
            box-shadow: var(--shadow-dark);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .card-header i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-gradient);
            color: white;
            border-radius: 8px;
            font-size: 12px;
        }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--glass-light);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        body.dark .stat-card {
            background: var(--glass-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::before {
            opacity: 0.05;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        body.dark .stat-label {
            color: var(--text-secondary-dark);
        }

        /* ========== CLIMA CARD ========== */
        .clima-card {
            background: var(--accent-gradient);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            gap: 20px;
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .clima-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 100% 0%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        }

        .clima-icon {
            font-size: 48px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .clima-info h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .clima-info p {
            opacity: 0.9;
            font-weight: 500;
        }

        /* ========== LINHA ITEMS ========== */
        .linha-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .linha-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--glass-light);
            opacity: 0;
            transition: var(--transition);
        }

        body.dark .linha-item::before {
            background: var(--glass-dark);
        }

        .linha-item:hover {
            transform: translateX(8px);
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .linha-item:hover::before {
            opacity: 1;
        }

        .linha-indicator {
            width: 12px;
            height: 48px;
            border-radius: 6px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .linha-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .linha-status {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-green);
        }

        .linha-status::before {
            content: '●';
            font-size: 8px;
        }

        /* ========== MAP CONTAINER ========== */
        .map-container {
            flex: 1;
            position: relative;
            background: var(--bg-light);
        }

        body.dark .map-container {
            background: var(--bg-dark);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }

        .map-controls {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .map-btn {
            width: 48px;
            height: 48px;
            background: var(--surface-light);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }

        body.dark .map-btn {
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary-dark);
        }

        .map-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .map-btn:hover::before {
            opacity: 0.1;
        }

        .map-btn i {
            position: relative;
            z-index: 1;
        }

        /* ========== NOTIFICATION PANEL ========== */
        .notification-panel {
            position: fixed;
            top: 80px;
            right: -420px;
            width: 400px;
            height: calc(100vh - 80px);
            background: var(--surface-light);
            backdrop-filter: blur(20px) saturate(180%);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1001;
            transition: var(--transition);
            overflow-y: auto;
            padding: 24px;
        }

        body.dark .notification-panel {
            background: var(--surface-dark);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-item {
            background: var(--glass-light);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 16px;
            transition: var(--transition);
            border-left: 4px solid var(--accent-blue);
        }

        body.dark .notification-item {
            background: var(--glass-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification-item:hover {
            transform: translateX(-8px);
            box-shadow: var(--shadow-light);
        }

        body.dark .notification-item:hover {
            box-shadow: var(--shadow-dark);
        }

        /* ========== LOADING OVERLAY ========== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 15, 35, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            inset: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid var(--accent-purple);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ========== LOADING OVERLAY ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
            color: white;
            animation: loadingFloat 3s ease-in-out infinite;
        }

        .loading-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
        }

        .spinner-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: loadingSpinner 1.5s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            animation-delay: -0.5s;
            border-top-color: rgba(255, 255, 255, 0.6);
        }

        .spinner-ring:nth-child(3) {
            animation-delay: -1s;
            border-top-color: rgba(255, 255, 255, 0.4);
        }

        .loading-content h3 {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 10px 0;
            letter-spacing: 1px;
        }

        .loading-content p {
            font-size: 16px;
            opacity: 0.8;
            margin: 0;
        }

        @keyframes loadingSpinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes loadingFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* ========== MAP CONTROLS ========== */
        .map-controls {
            position: absolute;
            top: 250px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 1);
        }

        .control-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .control-btn:hover::before {
            left: 100%;
        }

        .control-btn[data-tooltip] {
            position: relative;
        }

        .control-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            right: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1001;
            animation: tooltipFadeIn 0.3s ease;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(5px);
            }

            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        /* Dark theme para controles */
        .dark .control-btn {
            background: rgba(30, 30, 46, 0.95);
            color: var(--text-primary);
        }

        .dark .control-btn:hover {
            background: rgba(30, 30, 46, 1);
        }

        /* ========== RESPONSIVE MAP CONTROLS ========== */
        @media (max-width: 768px) {
            .map-controls {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .control-btn {
                width: 44px;
                height: 44px;
                font-size: 16px;
            }

            .control-btn[data-tooltip]:hover::after {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .map-controls {
                top: 70px;
                /* Evitar sobreposição com header */
                right: 10px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        }

        /* ========== TOOLTIP ANIMATIONS ========== */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip-content {
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 12px;
            font-weight: 500;
        }

        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }

        /* ========== MODAL STYLES ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body p {
            margin-bottom: 16px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .modal-body ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .modal-body li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .modal-body a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .modal-body a:hover {
            text-decoration: underline;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn-primary,
        .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }

            .modal-header,
            .modal-body {
                padding: 16px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .btn-primary,
            .btn-secondary {
                min-width: auto;
            }
        }

        /* ========== LEAFLET POPUP STYLES ========== */
        .popup-content {
            padding: 10px;
            max-width: 280px;
            font-family: 'Inter', sans-serif;
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            font-weight: 600;
            font-size: 16px;
        }

        .popup-content p {
            margin: 5px 0;
            font-size: 14px;
        }

        .train-marker-leaflet {
            border-radius: 50% !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        }

        /* Leaflet custom styles */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
        }

        .leaflet-popup-tip {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        .custom-popup .leaflet-popup-content {
            margin: 0 !important;
        }

        .custom-station-icon {
            border-radius: 50% !important;
        }

        /* Animação de pulse para estações */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Estilos para controles customizados do Leaflet */
        .leaflet-control-custom {
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            transition: all 0.2s ease !important;
        }

        .leaflet-control-custom:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        /* Melhorar aparência do controle de camadas */
        .leaflet-control-layers {
            border-radius: 12px !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
        }

        .leaflet-control-layers-toggle {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .707A8.237 8.237 0 016 18.75c1.995 0 3.823.707 5.25 1.886V4.533z"/><path d="M12.75 20.636A8.214 8.214 0 0118 18.75c.966 0 1.89.166 2.75.47a.75.75 0 001-.708V4.262a.75.75 0 00-.5-.707A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z"/></svg>') !important;
        }

        /* Customizar zoom controls */
        .leaflet-control-zoom {
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }

        .leaflet-control-zoom a {
            border-radius: 0 !important;
            transition: all 0.2s ease !important;
        }

        .leaflet-control-zoom a:first-child {
            border-top-left-radius: 8px !important;
            border-top-right-radius: 8px !important;
        }

        .leaflet-control-zoom a:last-child {
            border-bottom-left-radius: 8px !important;
            border-bottom-right-radius: 8px !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: var(--accent-color) !important;
            color: white !important;
        }

        /* Melhorar escala */
        .leaflet-control-scale {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border-radius: 8px !important;
            padding: 4px 8px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }

        /* Classes para ícones personalizados */
        .station-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .train-icon {
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .popup-content {
            padding: 10px;
            max-width: 250px;
        }

        .popup-content-train {
            padding: 10px;
            max-width: 300px;
        }

        .popup-title {
            margin: 0 0 10px 0;
        }

        .popup-button {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s ease;
        }

        .popup-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .status-indicator {
            font-weight: bold;
        }

        .status-operational {
            color: #27ae60;
        }

        .status-warning {
            color: #f39c12;
        }

        .status-error {
            color: #e74c3c;
        }

        .lotacao-baixa {
            color: #27ae60;
        }

        .lotacao-media {
            color: #f39c12;
        }

        .lotacao-alta {
            color: #e74c3c;
        }

        .weather-temp {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .weather-desc {
            opacity: 0.8;
        }

        /* Melhorar aparência do controle de geolocalização */
        .leaflet-control-locate {
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }

        .leaflet-control-locate a {
            background-color: white !important;
            color: var(--accent-color) !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        }

        .leaflet-control-locate a:hover {
            background-color: var(--accent-color) !important;
            color: white !important;
            transform: translateY(-1px) !important;
        }

        /* Indicador de localização do usuário */
        .user-location-marker {
            animation: pulse 2s infinite;
        }

        .user-location-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: rgba(74, 144, 226, 0.3);
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 320px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
                height: 70px;
            }

            .logo {
                font-size: 20px;
            }

            .logo i {
                font-size: 24px;
            }

            .control-btn {
                width: 44px;
                height: 44px;
            }

            .control-btn i {
                font-size: 16px;
            }

            .main-container {
                top: 70px;
            }

            .sidebar {
                position: fixed;
                left: -100vw;
                top: 0;
                width: 85vw;
                max-width: 350px;
                height: 100vh;
                z-index: 1002;
                transition: var(--transition);
                padding: 20px;
            }

            .sidebar.open {
                left: 0;
                box-shadow: var(--shadow-dark);
            }

            .card {
                padding: 20px;
                margin-bottom: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 24px;
            }

            .clima-card {
                flex-direction: column;
                text-align: center;
                gap: 16px;
                padding: 20px;
            }

            .clima-icon {
                font-size: 36px;
            }

            .linha-item {
                padding: 12px;
                gap: 12px;
            }

            .linha-indicator {
                width: 8px;
                height: 40px;
            }

            .map-controls {
                top: 16px;
                right: 16px;
                gap: 8px;
            }

            .map-btn {
                width: 44px;
                height: 44px;
                font-size: 16px;
            }

            .notification-panel {
                top: 70px;
                right: -100vw;
                width: 85vw;
                max-width: 350px;
                height: calc(100vh - 70px);
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 12px;
                height: 60px;
            }

            .logo {
                font-size: 18px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
            }

            .main-container {
                top: 60px;
            }

            .sidebar {
                width: 90vw;
                padding: 16px;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .card-header {
                font-size: 16px;
                margin-bottom: 16px;
            }

            .stats-grid {
                gap: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-number {
                font-size: 20px;
            }

            .stat-label {
                font-size: 10px;
            }

            .clima-card {
                padding: 16px;
            }

            .clima-icon {
                font-size: 32px;
            }

            .clima-info h3 {
                font-size: 20px;
            }

            .map-controls {
                top: 12px;
                right: 12px;
            }

            .map-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .notification-panel {
                width: 90vw;
                padding: 16px;
            }
        }

        /* ========== MOBILE OVERLAY ========== */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            transition: var(--transition);
        }

        .mobile-overlay.show {
            display: block;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .mobile-overlay {
                display: block;
            }
        }

        /* ========== ACCESSIBILITY ========== */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation: none !important;
                transition: none !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                color-scheme: dark;
            }
        }

        /* ========== TOUCH IMPROVEMENTS ========== */
        @media (hover: none) and (pointer: coarse) {

            .control-btn,
            .map-btn,
            .linha-item,
            .card {
                min-height: 44px;
                touch-action: manipulation;
            }

            .control-btn:hover,
            .map-btn:hover,
            .linha-item:hover,
            .card:hover {
                transform: none;
            }

            .control-btn:active,
            .map-btn:active {
                transform: scale(0.95);
            }
        }

        /* ========== DARK MODE SPECIFICS ========== */
        body.dark {
            --bg-light: var(--bg-dark);
            --surface-light: var(--surface-dark);
            --glass-light: var(--glass-dark);
            --text-primary-light: var(--text-primary-dark);
            --text-secondary-light: var(--text-secondary-dark);
            --shadow-light: var(--shadow-dark);
        }

        /* ========== UTILITY CLASSES ========== */
        .status-operational {
            color: var(--accent-green);
        }

        .status-atrasado {
            color: var(--accent-orange);
        }

        .status-manutencao {
            color: var(--accent-red);
        }

        .status-fora-servico {
            color: var(--text-secondary-light);
        }

        .lotacao-baixa {
            color: var(--accent-green);
        }

        .lotacao-media {
            color: var(--accent-orange);
        }

        .lotacao-alta {
            color: var(--accent-red);
        }

        .lotacao-superlotado {
            color: var(--accent-purple);
        }

        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-morphism {
            background: var(--glass-light);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark .glass-morphism {
            background: var(--glass-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <header class="header">
        <div class="logo">
            <i class="fas fa-subway"></i>
            CPTM Tracker
        </div>
        <div class="header-controls">
            <button class="control-btn" id="sidebarToggle" title="Menu">
                <i class="fas fa-bars"></i>
            </button>
            <button class="control-btn" id="mapToggle" title="Alternar Mapa" onclick="toggleMapProvider()">
                <i class="fas fa-map"></i>
            </button>
            <button class="control-btn" id="notificationToggle" title="Notificações">
                <i class="fas fa-bell"></i>
            </button>
            <button class="control-btn" id="refreshData" title="Atualizar">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="control-btn theme-toggle" id="themeToggle" title="Alternar tema">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Overlay para mobile -->
        <div class="mobile-overlay" id="mobileOverlay"></div>

        <div class="sidebar" id="sidebar">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    Estatísticas em Tempo Real
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTrens">{{ total_trens }}</div>
                        <div class="stat-label">Trens Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEstacoes">{{ total_estacoes }}</div>
                        <div class="stat-label">Estações</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="trensOperacionais">{{ trens_operacionais }}</div>
                        <div class="stat-label">Operacionais</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">7</div>
                        <div class="stat-label">Linhas</div>
                    </div>
                </div>
            </div>

            <div class="clima-card" id="climaCard">
                <div class="clima-icon">
                    <i class="fas fa-sun"></i>
                </div>
                <div class="clima-info">
                    <h3>Carregando...</h3>
                    <p>Condições climáticas</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-route"></i>
                    Linhas da CPTM
                </div>
                <div id="linhasList">
                    {% for linha in linhas %}
                    <div class="linha-item" data-linha="{{ linha.numero }}" onclick="focusOnLine('{{ linha.numero }}')">
                        <div class="linha-indicator" data-cor="{{ linha.cor }}"></div>
                        <div class="linha-info">
                            <h4>{{ linha.nome }}</h4>
                            <div class="linha-status">Operacional</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" onclick="centerMap()" title="Centralizar mapa">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="map-btn" onclick="toggleTraffic()" title="Trânsito">
                    <i class="fas fa-car"></i>
                </button>
                <button class="map-btn" onclick="toggleFullscreen()" title="Tela cheia">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="map-btn" onclick="toggleSatellite()" title="Visão satélite">
                    <i class="fas fa-satellite"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="notification-panel" id="notificationPanel">
        <div class="card-header">
            <i class="fas fa-bell"></i>
            Notificações e Alertas
        </div>
        <div id="notificationsList">
            <div class="notification-item">
                <h4>Sistema Online</h4>
                <p>Todos os sistemas estão funcionando normalmente.</p>
                <small>Agora</small>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURAÇÃO GLOBAL ==========
        let map;
        let markers = {};
        let trainMarkers = {};
        let linePolylines = {};
        let lineTrajectories = {};
        let stationControlPoints = {};
        let markerLayer;
        let infoWindow;
        let trafficLayer;
        let isTrafficVisible = false;
        let isSatelliteView = false;

        // Dados do backend
        const estacoes = {{ estacoes_json| safe }};
        const trens = {{ trens_json| safe }};
        const climaData = {{ clima_json| safe }};

        // ========== COORDENADAS OFICIAIS CPTM ==========
        const ESTACOES_CPTM = {
            // Linha 7-Rubi (Luz ↔ Jundiaí)
            'Luz': { lat: -23.534684, lng: -46.635199, linha: '7', cor: '#CA016B' },
            'Palmeiras–Barra Funda': { lat: -23.525944, lng: -46.667417, linha: '7', cor: '#CA016B' },
            'Água Branca': { lat: -23.520150, lng: -46.681050, linha: '7', cor: '#CA016B' },
            'Lapa': { lat: -23.516033, lng: -46.700721, linha: '7', cor: '#CA016B' },
            'Piqueri': { lat: -23.505199, lng: -46.720368, linha: '7', cor: '#CA016B' },
            'Pirituba': { lat: -23.485199, lng: -46.739368, linha: '7', cor: '#CA016B' },
            'Vila Clarice': { lat: -23.465199, lng: -46.740368, linha: '7', cor: '#CA016B' },
            'Jaraguá': { lat: -23.445199, lng: -46.741368, linha: '7', cor: '#CA016B' },
            'Perus': { lat: -23.410283, lng: -46.742836, linha: '7', cor: '#CA016B' },
            'Caieiras': { lat: -23.366469, lng: -46.740847, linha: '7', cor: '#CA016B' },
            'Franco da Rocha': { lat: -23.324103, lng: -46.726461, linha: '7', cor: '#CA016B' },
            'Baltazar Fidélis': { lat: -23.305103, lng: -46.735461, linha: '7', cor: '#CA016B' },
            'Francisco Morato': { lat: -23.286847, lng: -46.744932, linha: '7', cor: '#CA016B' },
            'Botujuru': { lat: -23.250847, lng: -46.770932, linha: '7', cor: '#CA016B' },
            'Campo Limpo Paulista': { lat: -23.210847, lng: -46.800932, linha: '7', cor: '#CA016B' },
            'Várzea Paulista': { lat: -23.190847, lng: -46.830932, linha: '7', cor: '#CA016B' },
            'Jundiaí': { lat: -23.178453, lng: -46.887738, linha: '7', cor: '#CA016B' },

            // Linha 8-Diamante (Júlio Prestes ↔ Amador Bueno)
            'Júlio Prestes': { lat: -23.535484, lng: -46.637299, linha: '8', cor: '#97A098' },
            'Domingos de Moraes': { lat: -23.520033, lng: -46.720721, linha: '8', cor: '#97A098' },
            'Imperatriz Leopoldina': { lat: -23.525033, lng: -46.750721, linha: '8', cor: '#97A098' },
            'Presidente Altino': { lat: -23.530033, lng: -46.780721, linha: '8', cor: '#97A098' },
            'Osasco': { lat: -23.532837, lng: -46.791898, linha: '8', cor: '#97A098' },
            'Comandante Sampaio': { lat: -23.531837, lng: -46.805898, linha: '8', cor: '#97A098' },
            'Quitaúna': { lat: -23.530837, lng: -46.810898, linha: '8', cor: '#97A098' },
            'General Miguel Costa': { lat: -23.525837, lng: -46.825898, linha: '8', cor: '#97A098' },
            'Carapicuíba': { lat: -23.522337, lng: -46.835699, linha: '8', cor: '#97A098' },
            'Santa Terezinha': { lat: -23.520337, lng: -46.845699, linha: '8', cor: '#97A098' },
            'Antônio João': { lat: -23.518337, lng: -46.855699, linha: '8', cor: '#97A098' },
            'Barueri': { lat: -23.510837, lng: -46.876199, linha: '8', cor: '#97A098' },
            'Jardim Belval': { lat: -23.515837, lng: -46.885199, linha: '8', cor: '#97A098' },
            'Jardim Silveira': { lat: -23.518837, lng: -46.895199, linha: '8', cor: '#97A098' },
            'Jandira': { lat: -23.525837, lng: -46.905199, linha: '8', cor: '#97A098' },
            'Sagrado Coração': { lat: -23.530837, lng: -46.915199, linha: '8', cor: '#97A098' },
            'Engenheiro Cardoso': { lat: -23.535837, lng: -46.925199, linha: '8', cor: '#97A098' },
            'Itapevi': { lat: -23.540837, lng: -46.935199, linha: '8', cor: '#97A098' },
            'Santa Rita': { lat: -23.545837, lng: -46.945199, linha: '8', cor: '#97A098' },
            'Cimenrita': { lat: -23.548837, lng: -46.950199, linha: '8', cor: '#97A098' },
            'Ambuitá': { lat: -23.551837, lng: -46.955199, linha: '8', cor: '#97A098' },
            'Amador Bueno': { lat: -23.550837, lng: -46.955199, linha: '8', cor: '#97A098' },

            // Linha 9-Esmeralda (Osasco ↔ Bruno Covas/Mendes–Vila Natal)
            'Ceasa': { lat: -23.540337, lng: -46.755199, linha: '9', cor: '#01A1C9' },
            'Villa Lobos–Jaguaré': { lat: -23.548337, lng: -46.724199, linha: '9', cor: '#01A1C9' },
            'Cidade Universitária': { lat: -23.558337, lng: -46.725199, linha: '9', cor: '#01A1C9' },
            'Pinheiros': { lat: -23.561837, lng: -46.685199, linha: '9', cor: '#01A1C9' },
            'Hebraica–Rebouças': { lat: -23.558337, lng: -46.668199, linha: '9', cor: '#01A1C9' },
            'Cidade Jardim': { lat: -23.568337, lng: -46.753199, linha: '9', cor: '#01A1C9' },
            'Vila Olímpia': { lat: -23.568337, lng: -46.688199, linha: '9', cor: '#01A1C9' },
            'Berrini': { lat: -23.628337, lng: -46.693199, linha: '9', cor: '#01A1C9' },
            'Morumbi': { lat: -23.618337, lng: -46.703199, linha: '9', cor: '#01A1C9' },
            'Granja Julieta': { lat: -23.608337, lng: -46.713199, linha: '9', cor: '#01A1C9' },
            'João Dias': { lat: -23.598337, lng: -46.718199, linha: '9', cor: '#01A1C9' },
            'Santo Amaro': { lat: -23.598337, lng: -46.723199, linha: '9', cor: '#01A1C9' },
            'Socorro': { lat: -23.588337, lng: -46.733199, linha: '9', cor: '#01A1C9' },
            'Jurubatuba': { lat: -23.578337, lng: -46.743199, linha: '9', cor: '#01A1C9' },
            'Autódromo': { lat: -23.750337, lng: -46.697199, linha: '9', cor: '#01A1C9' },
            'Primavera–Interlagos': { lat: -23.720337, lng: -46.697199, linha: '9', cor: '#01A1C9' },
            'Grajaú': { lat: -23.777337, lng: -46.697199, linha: '9', cor: '#01A1C9' },
            'Bruno Covas/Mendes–Vila Natal': { lat: -23.787337, lng: -46.697199, linha: '9', cor: '#01A1C9' },

            // Linha 10-Turquesa (Brás ↔ Rio Grande da Serra)
            'Brás': { lat: -23.525484, lng: -46.615299, linha: '10', cor: '#049FC3' },
            'Juventus–Mooca': { lat: -23.551891, lng: -46.607743, linha: '10', cor: '#049FC3' },
            'Ipiranga': { lat: -23.592891, lng: -46.597743, linha: '10', cor: '#049FC3' },
            'Tamanduateí': { lat: -23.602891, lng: -46.587743, linha: '10', cor: '#049FC3' },
            'São Caetano do Sul–Prefeito Walter Braido': { lat: -23.618891, lng: -46.564743, linha: '10', cor: '#049FC3' },
            'Utinga': { lat: -23.628891, lng: -46.554743, linha: '10', cor: '#049FC3' },
            'Prefeito Saladino': { lat: -23.638891, lng: -46.544743, linha: '10', cor: '#049FC3' },
            'Prefeito Celso Daniel–Santo André': { lat: -23.648891, lng: -46.534743, linha: '10', cor: '#049FC3' },
            'Capuava': { lat: -23.658891, lng: -46.524743, linha: '10', cor: '#049FC3' },
            'Mauá': { lat: -23.668891, lng: -46.514743, linha: '10', cor: '#049FC3' },
            'Guapituba': { lat: -23.678891, lng: -46.504743, linha: '10', cor: '#049FC3' },
            'Ribeirão Pires–Antônio Bespalec': { lat: -23.688891, lng: -46.494743, linha: '10', cor: '#049FC3' },
            'Rio Grande da Serra': { lat: -23.698891, lng: -46.484743, linha: '10', cor: '#049FC3' },

            // Linha 11-Coral (Palmeiras-Barra Funda ↔ Estudantes) - COORDENADAS OFICIAIS SITE CPTM
            'Palmeiras–Barra Funda': { lat: -23.525944, lng: -46.667417, linha: '11', cor: '#F68368' },
            'Luz': { lat: -23.5350, lng: -46.6335, linha: '11', cor: '#F68368' },
            'Brás': { lat: -23.544045, lng: -46.616843, linha: '11', cor: '#F68368' },
            'Tatuapé': { lat: -23.540794, lng: -46.579013, linha: '11', cor: '#F68368' },
            'Corinthians–Itaquera': { lat: -23.542660, lng: -46.471231, linha: '11', cor: '#F68368' },
            'Dom Bosco': { lat: -23.542598, lng: -46.445735, linha: '11', cor: '#F68368' },
            'José Bonifácio': { lat: -23.539398, lng: -46.431285, linha: '11', cor: '#F68368' },
            'Guaianases': { lat: -23.542344, lng: -46.415581, linha: '11', cor: '#F68368' },
            'Antonio Gianetti Neto': { lat: -23.554375, lng: -46.383640, linha: '11', cor: '#F68368' },
            'Ferraz de Vasconcelos': { lat: -23.540776, lng: -46.368239, linha: '11', cor: '#F68368' },
            'Poá': { lat: -23.525441, lng: -46.343600, linha: '11', cor: '#F68368' },
            'Suzano': { lat: -23.534001, lng: -46.308004, linha: '11', cor: '#F68368' },
            'Calmon Viana': { lat: -23.525709, lng: -46.332359, linha: '11', cor: '#F68368' },
            'Jundiapeba': { lat: -23.542825, lng: -46.258101, linha: '11', cor: '#F68368' },
            'Brás Cubas': { lat: -23.536327, lng: -46.225501, linha: '11', cor: '#F68368' },
            'Mogi das Cruzes': { lat: -23.521799, lng: -46.197950, linha: '11', cor: '#F68368' },
            'Estudantes': { lat: -23.515680, lng: -46.184834, linha: '11', cor: '#F68368' },

            // Linha 12-Safira (Brás ↔ Calmon Viana)
            'Engenheiro Goulart': { lat: -23.535391, lng: -46.560391, linha: '12', cor: '#133C8D' },
            'USP Leste': { lat: -23.530391, lng: -46.550391, linha: '12', cor: '#133C8D' },
            'Comendador Ermelino': { lat: -23.525391, lng: -46.540391, linha: '12', cor: '#133C8D' },
            'São Miguel Paulista': { lat: -23.498484, lng: -46.443299, linha: '12', cor: '#133C8D' },
            'Jardim Helena–Vila Mara': { lat: -23.515391, lng: -46.520391, linha: '12', cor: '#133C8D' },
            'Itaim Paulista': { lat: -23.510391, lng: -46.510391, linha: '12', cor: '#133C8D' },
            'Jardim Romano': { lat: -23.505391, lng: -46.500391, linha: '12', cor: '#133C8D' },
            'Engenheiro Manoel Feio': { lat: -23.500391, lng: -46.490391, linha: '12', cor: '#133C8D' },
            'Itaquaquecetuba': { lat: -23.479484, lng: -46.343299, linha: '12', cor: '#133C8D' },
            'Aracaré': { lat: -23.490391, lng: -46.470391, linha: '12', cor: '#133C8D' },

            // Linha 13-Jade (Engenheiro Goulart ↔ Aeroporto-Guarulhos)
            'Guarulhos–Cecap': { lat: -23.462103, lng: -46.533265, linha: '13', cor: '#00B04F' },
            'Aeroporto–Guarulhos': { lat: -23.432850, lng: -46.473201, linha: '13', cor: '#00B04F' }
        };

        // ========== CORES DAS LINHAS ==========
        const CORES_LINHAS = {
            '7': '#CA016B',  // Rubi
            '8': '#97A098',  // Diamante
            '9': '#01A1C9',  // Esmeralda
            '10': '#049FC3', // Turquesa
            '11': '#F68368', // Coral
            '12': '#133C8D', // Safira
            '13': '#00B04F'  // Jade
        };

        // ========== FUNÇÕES DE NOME DAS LINHAS ==========
        function getLineName(numeroLinha) {
            const nomes = {
                '7': 'Linha 7-Rubi',
                '8': 'Linha 8-Diamante',
                '9': 'Linha 9-Esmeralda',
                '10': 'Linha 10-Turquesa',
                '11': 'Linha 11-Coral',
                '12': 'Linha 12-Safira',
                '13': 'Linha 13-Jade'
            };
            return nomes[numeroLinha] || `Linha ${numeroLinha}`;
        }

        // ========== INICIALIZAÇÃO DE TRAJETOS DAS LINHAS ==========
        function initLineTrajectories() {
            console.log('🚇 Inicializando trajetos das linhas CPTM...');

            // Organizar estações por linha seguindo a ordem geográfica
            const ORDEM_ESTACOES = {
                '7': [
                    'Luz', 'Palmeiras–Barra Funda', 'Água Branca', 'Lapa', 'Piqueri',
                    'Pirituba', 'Vila Clarice', 'Jaraguá', 'Perus', 'Caieiras',
                    'Franco da Rocha', 'Baltazar Fidélis', 'Francisco Morato',
                    'Botujuru', 'Campo Limpo Paulista', 'Várzea Paulista', 'Jundiaí'
                ],
                '8': [
                    'Júlio Prestes', 'Domingos de Moraes', 'Imperatriz Leopoldina',
                    'Presidente Altino', 'Osasco', 'Comandante Sampaio', 'Quitaúna',
                    'General Miguel Costa', 'Carapicuíba', 'Santa Terezinha',
                    'Antônio João', 'Barueri', 'Jardim Belval', 'Jardim Silveira',
                    'Jandira', 'Sagrado Coração', 'Engenheiro Cardoso', 'Itapevi',
                    'Santa Rita', 'Cimenrita', 'Ambuitá', 'Amador Bueno'
                ],
                '9': [
                    'Osasco', 'Ceasa', 'Villa Lobos–Jaguaré', 'Cidade Universitária',
                    'Pinheiros', 'Hebraica–Rebouças', 'Cidade Jardim', 'Vila Olímpia',
                    'Berrini', 'Morumbi', 'Granja Julieta', 'João Dias', 'Santo Amaro',
                    'Socorro', 'Jurubatuba', 'Autódromo', 'Primavera–Interlagos',
                    'Grajaú', 'Bruno Covas/Mendes–Vila Natal'
                ],
                '10': [
                    'Luz', 'Brás', 'Juventus–Mooca', 'Ipiranga', 'Tamanduateí',
                    'São Caetano do Sul–Prefeito Walter Braido', 'Utinga',
                    'Prefeito Saladino', 'Prefeito Celso Daniel–Santo André', 'Capuava',
                    'Mauá', 'Guapituba', 'Ribeirão Pires–Antônio Bespalec', 'Rio Grande da Serra'
                ],
                '11': [
                    'Luz', 'Brás', 'Tatuapé', 'Corinthians–Itaquera', 'Dom Bosco',
                    'José Bonifácio', 'Guaianases', 'Antonio Gianetti Neto',
                    'Ferraz de Vasconcelos', 'Poá', 'Suzano', 'Calmon Viana', 'Jundiapeba',
                    'Brás Cubas', 'Mogi das Cruzes', 'Estudantes'
                ],
                '12': [
                    'Brás', 'Engenheiro Goulart', 'USP Leste', 'Comendador Ermelino',
                    'São Miguel Paulista', 'Jardim Helena–Vila Mara', 'Itaim Paulista',
                    'Jardim Romano', 'Engenheiro Manoel Feio', 'Itaquaquecetuba',
                    'Aracaré', 'Calmon Viana'
                ],
                '13': [
                    'Engenheiro Goulart', 'Guarulhos–Cecap'
                ]
            };

            // Gerar trajetos baseados nas coordenadas das estações
            Object.entries(ORDEM_ESTACOES).forEach(([numeroLinha, ordemEstacoes]) => {
                const coordenadasLinha = [];
                const estacoesLinha = [];

                ordemEstacoes.forEach(nomeEstacao => {
                    const dadosEstacao = ESTACOES_CPTM[nomeEstacao];
                    if (dadosEstacao && dadosEstacao.linha === numeroLinha) {
                        coordenadasLinha.push([dadosEstacao.lat, dadosEstacao.lng]);
                        estacoesLinha.push({
                            nome: nomeEstacao,
                            ...dadosEstacao
                        });
                    }
                });

                if (coordenadasLinha.length > 1) {
                    lineTrajectories[numeroLinha] = {
                        numero: numeroLinha,
                        nome: getLineName(numeroLinha),
                        cor: CORES_LINHAS[numeroLinha],
                        coordinates: coordenadasLinha,
                        estacoes: estacoesLinha
                    };
                }
            });

            console.log('✅ Trajetos das linhas inicializados:', Object.keys(lineTrajectories));
        }

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
            startDataRefresh();
        });

        function initializeApp() {
            showLoading();
            updateClimateInfo();
            updateLineIndicators();
            setTimeout(hideLoading, 2000);
        }

        // ========== GOOGLE MAPS INITIALIZATION ==========
        function initGoogleMap() {
            console.log('🗺️ Inicializando Google Maps...');

            try {
                // Verificar se a API do Google Maps está disponível
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    throw new Error('Google Maps API não carregada');
                }

                // Configuração do mapa com estilo futurista
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 11,
                    center: { lat: -23.5505, lng: -46.6333 }, // Centro de São Paulo
                    styles: getMapStyles(),
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    zoomControl: false,
                    gestureHandling: 'greedy',
                    backgroundColor: '#0f0f23'
                });

                // Info window para popups
                infoWindow = new google.maps.InfoWindow();

                // Camada de trânsito
                trafficLayer = new google.maps.TrafficLayer();

                // Adicionar estações
                addGoogleMapsStations();

                // Desenhar linhas das rotas
                drawGoogleMapsLines();

                // Adicionar trens
                addGoogleMapsTrains();

                console.log('✅ Google Maps inicializado com sucesso!');

            } catch (error) {
                console.warn('⚠️ Falha ao inicializar Google Maps:', error);
                initMapFallback();
            }
        }

        // Função global para callback da API
        window.initMap = function () {
            try {
                initGoogleMap();
            } catch (error) {
                console.warn('⚠️ Erro no callback do Google Maps:', error);
                initMapFallback();
            }
        };

        // ========== ESTILOS DO MAPA ==========
        function getMapStyles() {
            const isDark = document.body.classList.contains('dark');

            if (isDark) {
                return [
                    { elementType: 'geometry', stylers: [{ color: '#0f0f23' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#0f0f23' }] },
                    {
                        featureType: 'administrative.locality',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'geometry',
                        stylers: [{ color: '#1a1a2e' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{ color: '#16213e' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#0e3d59' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{ color: '#2c5f75' }]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{ color: '#3b82f6' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{ color: '#1e3a8a' }]
                    }
                ];
            } else {
                return [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{ color: '#e1f5fe' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{ color: '#bbdefb' }]
                    }
                ];
            }
        }

        // ========== ADICIONAR ESTAÇÕES NO GOOGLE MAPS ==========
        function addGoogleMapsStations() {
            Object.entries(ESTACOES_CPTM).forEach(([nome, dados]) => {
                const marker = new google.maps.Marker({
                    position: { lat: dados.lat, lng: dados.lng },
                    map: map,
                    title: nome,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: dados.cor,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3,
                        strokeOpacity: 1
                    },
                    zIndex: 100
                });

                marker.addListener('click', () => {
                    const content = `
                        <div style="padding: 15px; max-width: 300px; font-family: 'Inter', sans-serif;">
                            <h3 style="margin: 0 0 10px 0; color: ${dados.cor}; font-weight: 600;">
                                🚉 ${nome}
                            </h3>
                            <div style="margin-bottom: 10px;">
                                <strong>Linha:</strong> ${dados.linha} - ${getLineName(dados.linha)}
                            </div>
                            <div style="background: ${dados.cor}; color: white; padding: 8px 12px; border-radius: 20px; text-align: center; font-weight: 500; margin-top: 10px;">
                                ● Operacional
                            </div>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });

                markers[nome] = marker;
            });
        }

        // ========== DESENHAR LINHAS NO GOOGLE MAPS ==========
        function drawGoogleMapsLines() {
            const linhas = {
                '7': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '7').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng })),
                '8': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '8').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng })),
                '9': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '9').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng })),
                '10': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '10').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng })),
                '11': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '11').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng })),
                '12': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '12').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng })),
                '13': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '13').map(([nome, dados]) => ({ lat: dados.lat, lng: dados.lng }))
            };

            Object.entries(linhas).forEach(([numeroLinha, coordenadas]) => {
                if (coordenadas.length > 1) {
                    const polyline = new google.maps.Polyline({
                        path: coordenadas,
                        geodesic: true,
                        strokeColor: CORES_LINHAS[numeroLinha],
                        strokeOpacity: 0.8,
                        strokeWeight: 6,
                        zIndex: 50
                    });

                    polyline.setMap(map);
                    linePolylines[numeroLinha] = polyline;

                    // Adicionar listener para destacar linha
                    polyline.addListener('click', () => {
                        focusOnGoogleMapsLine(numeroLinha);
                    });
                }
            });
        }

        // ========== ADICIONAR TRENS NO GOOGLE MAPS ==========
        function addGoogleMapsTrains() {
            if (trens && Array.isArray(trens)) {
                trens.forEach(trem => {
                    if (trem && typeof trem.latitude === 'number' && typeof trem.longitude === 'number' &&
                        !isNaN(trem.latitude) && !isNaN(trem.longitude)) {
                        addGoogleMapsTrainMarker(trem);
                    }
                });
            }
        }

        function addGoogleMapsTrainMarker(trem) {
            const cor = CORES_LINHAS[trem.linha] || '#3498db';

            const marker = new google.maps.Marker({
                position: { lat: trem.latitude, lng: trem.longitude },
                map: map,
                title: `Trem ${trem.identificador}`,
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 6,
                    fillColor: cor,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    rotation: trem.direcao_graus || 0
                },
                zIndex: 200
            });

            marker.addListener('click', () => {
                const content = `
                    <div style="padding: 15px; max-width: 350px; font-family: 'Inter', sans-serif;">
                        <h3 style="margin: 0 0 15px 0; color: ${cor}; font-weight: 600;">
                            🚆 Trem ${trem.identificador}
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div><strong>Linha:</strong> ${trem.linha_nome || 'N/A'}</div>
                            <div><strong>Velocidade:</strong> ${trem.velocidade || 0} km/h</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div><strong>Status:</strong> <span style="color: ${getStatusColor(trem.status)};">● ${trem.status || 'N/A'}</span></div>
                            <div><strong>Lotação:</strong> <span style="color: ${getLotacaoColor(trem.lotacao)};">● ${trem.lotacao || 'N/A'}</span></div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <div><strong>📍 Estação atual:</strong> ${trem.estacao_atual || 'Em trânsito'}</div>
                            <div><strong>➡️ Próxima estação:</strong> ${trem.proxima_estacao || 'Indisponível'}</div>
                        </div>
                    </div>
                `;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });

            trainMarkers[trem.id] = marker;
        }

        function focusOnGoogleMapsLine(lineNumber) {
            const polyline = linePolylines[lineNumber];
            if (polyline) {
                const bounds = new google.maps.LatLngBounds();
                polyline.getPath().forEach(latLng => bounds.extend(latLng));
                map.fitBounds(bounds);

                // Destacar linha temporariamente
                const originalWeight = polyline.strokeWeight;
                polyline.setOptions({ strokeWeight: 10 });

                setTimeout(() => {
                    polyline.setOptions({ strokeWeight: originalWeight });
                }, 2000);

                showNotification(`Focalizando ${getLineName(lineNumber)}`, 'info');
            }
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('notificationToggle').addEventListener('click', toggleNotifications);
            document.getElementById('refreshData').addEventListener('click', refreshAllData);

            // Responsive handling
            window.addEventListener('resize', handleResize);
        }

        // ========== FUNÇÕES DE CONTROLE ==========
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('themeToggle').innerHTML =
                `<i class="fas ${isDark ? 'fa-sun' : 'fa-moon'}"></i>`;

            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Atualizar estilo do mapa
            if (map) {
                map.setOptions({ styles: getMapStyles() });
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const isMobile = window.innerWidth <= 768;

            sidebar.classList.toggle('open');

            if (isMobile) {
                mobileOverlay.classList.toggle('show');

                mobileOverlay.onclick = () => {
                    sidebar.classList.remove('open');
                    mobileOverlay.classList.remove('show');
                };

                if (sidebar.classList.contains('open')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        function toggleNotifications() {
            const notificationPanel = document.getElementById('notificationPanel');
            const isMobile = window.innerWidth <= 768;

            notificationPanel.classList.toggle('open');

            if (isMobile && notificationPanel.classList.contains('open')) {
                const sidebar = document.getElementById('sidebar');
                const mobileOverlay = document.getElementById('mobileOverlay');

                sidebar.classList.remove('open');
                mobileOverlay.classList.remove('show');

                document.body.style.overflow = 'hidden';

                setTimeout(() => {
                    const clickOutsideHandler = (e) => {
                        if (!notificationPanel.contains(e.target) &&
                            !e.target.closest('#notificationToggle')) {
                            notificationPanel.classList.remove('open');
                            document.body.style.overflow = '';
                            document.removeEventListener('click', clickOutsideHandler);
                        }
                    };
                    document.addEventListener('click', clickOutsideHandler);
                }, 100);
            } else if (!notificationPanel.classList.contains('open')) {
                document.body.style.overflow = '';
            }
        }

        function refreshAllData() {
            showLoading();

            Promise.all([
                fetch('/api/trens/').then(r => r.json()),
                fetch('/api/clima/').then(r => r.json())
            ]).then(([tremsData, climaData]) => {
                // Atualizar marcadores de trens
                if (tremsData && tremsData.trens && Array.isArray(tremsData.trens)) {
                    tremsData.trens.forEach(trem => {
                        if (trem && trem.id) {
                            updateTrainMarker(trem);
                        }
                    });
                }

                // Atualizar informações climáticas
                if (climaData && climaData.clima) {
                    updateClimateInfo(climaData.clima);
                }

                hideLoading();
                showNotification('Dados atualizados com sucesso!', 'success');
            }).catch(error => {
                hideLoading();
                showNotification('Erro ao atualizar dados', 'error');
                console.error('Erro:', error);
            });
        }

        // ========== CONTROLES DO MAPA (GOOGLE MAPS) ==========
        function centerMap() {
            if (map && map.setCenter) {
                map.setCenter({ lat: -23.5505, lng: -46.6333 });
                map.setZoom(11);
                showNotification('Mapa centralizado', 'info');
            }
        }

        function toggleTraffic() {
            if (trafficLayer && map) {
                if (isTrafficVisible) {
                    trafficLayer.setMap(null);
                    isTrafficVisible = false;
                    showNotification('Trânsito ocultado', 'info');
                } else {
                    trafficLayer.setMap(map);
                    isTrafficVisible = true;
                    showNotification('Trânsito exibido', 'info');
                }
            }
        }

        function toggleSatellite() {
            if (map && map.setMapTypeId) {
                if (isSatelliteView) {
                    map.setMapTypeId('roadmap');
                    isSatelliteView = false;
                    showNotification('Visão de mapa', 'info');
                } else {
                    map.setMapTypeId('satellite');
                    isSatelliteView = true;
                    showNotification('Visão satélite', 'info');
                }
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    showNotification('Modo tela cheia ativado', 'info');
                });
            } else {
                document.exitFullscreen().then(() => {
                    showNotification('Modo tela cheia desativado', 'info');
                });
            }
        }

        // ========== FUNÇÕES UTILITÁRIAS ==========
        function focusOnLine(lineNumber) {
            const polyline = linePolylines[lineNumber];
            if (polyline) {
                const bounds = new google.maps.LatLngBounds();
                polyline.getPath().forEach(latLng => bounds.extend(latLng));
                map.fitBounds(bounds);

                // Destacar linha temporariamente
                const originalWeight = polyline.strokeWeight;
                polyline.setOptions({ strokeWeight: 10 });

                setTimeout(() => {
                    polyline.setOptions({ strokeWeight: originalWeight });
                }, 2000);

                // Funcionalidade especial para Linha 11 - Coral
                if (lineNumber === '11') {
                    console.log(`🚊 Iniciando simulação para Linha 11-Coral`);
                    showNotification(`🚊 Iniciando simulação em tempo real da ${getLineName(lineNumber)}`, 'success');
                    startLine11RealTimeSimulation();
                } else {
                    showNotification(`Focalizando ${getLineName(lineNumber)}`, 'info');
                }
            } else {
                console.warn(`⚠️ Polyline não encontrada para linha ${lineNumber}`);
                console.log('🔍 linePolylines disponíveis:', Object.keys(linePolylines || {}));

                // Tentar usar sistema Leaflet como fallback
                if (typeof map !== 'undefined' && map.hasOwnProperty('_container')) {
                    console.log('🍃 Tentando usar sistema Leaflet como fallback...');
                    focusOnLineLeaflet(lineNumber);
                } else {
                    showNotification(`Erro: Linha ${lineNumber} não encontrada no mapa`, 'error');
                }
            }
        }

        function focusOnLineLeaflet(lineNumber) {
            console.log(`🍃 focusOnLineLeaflet chamado para linha: ${lineNumber}`);

            // Implementar foco na linha específica
            const lineTrains = trens.filter(t => t.linha === lineNumber);
            if (lineTrains.length > 0) {
                const group = new L.featureGroup();
                lineTrains.forEach(train => {
                    const marker = trainMarkers[train.id];
                    if (marker) {
                        group.addLayer(marker);
                    }
                });
                if (group.getLayers().length > 0) {
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            } else {
                // Se não há trens, focar nas estações da linha
                const stationsOfLine = Object.entries(ESTACOES_CPTM || {})
                    .filter(([nome, dados]) => dados.linha === lineNumber)
                    .map(([nome, dados]) => [dados.lat, dados.lng]);

                if (stationsOfLine.length > 0) {
                    console.log(`🚉 Focando em ${stationsOfLine.length} estações da linha ${lineNumber}`);
                    const group = new L.featureGroup();
                    stationsOfLine.forEach(coord => {
                        L.marker(coord).addTo(group);
                    });
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            // Funcionalidade especial para Linha 11 - Coral
            if (lineNumber === '11') {
                console.log(`🚊 Iniciando simulação para Linha 11-Coral via Leaflet`);
                showNotification(`🚊 Iniciando simulação em tempo real da ${getLineName(lineNumber)}`, 'success');
                startLine11RealTimeSimulation();
            } else {
                showNotification(`Focalizando ${getLineName(lineNumber)}`, 'info');
            }
        }

        function getLineName(numero) {
            const nomes = {
                '7': 'Linha 7-Rubi',
                '8': 'Linha 8-Diamante',
                '9': 'Linha 9-Esmeralda',
                '10': 'Linha 10-Turquesa',
                '11': 'Linha 11-Coral',
                '12': 'Linha 12-Safira',
                '13': 'Linha 13-Jade'
            };
            return nomes[numero] || `Linha ${numero}`;
        }

        // Sistema de simulação em tempo real para Linha 11 - Coral
        let line11Trains = [];
        let line11SimulationInterval;
        let line11TrainMarkers = [];

        function startLine11RealTimeSimulation() {
            // Limpar simulação anterior se existir
            stopLine11Simulation();

            // Inicializar trens da Linha 11
            initializeLine11Trains();

            // Iniciar animação dos trens
            line11SimulationInterval = setInterval(updateLine11Trains, 2000); // Atualização a cada 2 segundos

            showNotification('🚊 Simulação da Linha 11-Coral iniciada', 'success');
        }

        function stopLine11Simulation() {
            if (line11SimulationInterval) {
                clearInterval(line11SimulationInterval);
                line11SimulationInterval = null;
            }

            // Remover todos os marcadores de trens
            line11TrainMarkers.forEach(marker => {
                marker.setMap(null);
            });
            line11TrainMarkers = [];
        }

        function initializeLine11Trains() {
            // Obter todas as estações da Linha 11 em ordem
            const line11Stations = ORDEM_ESTACOES['11'].map(nomeEstacao => {
                const estacao = ESTACOES_CPTM[nomeEstacao];
                return {
                    nome: nomeEstacao,
                    lat: estacao.lat,
                    lng: estacao.lng,
                    cor: estacao.cor
                };
            });

            // Criar trens simulados
            line11Trains = [
                {
                    id: 'T11001',
                    nome: 'Trem Expresso 001',
                    direcao: 'Sentido Luz',
                    currentStationIndex: 0,
                    targetStationIndex: 1,
                    progress: 0, // 0 = na estação atual, 1 = na próxima estação
                    speed: 0.02, // Velocidade de movimento (ajustável)
                    lotacao: 'Média',
                    status: 'Em movimento',
                    nextArrival: '2 min',
                    passageiros: Math.floor(Math.random() * 800) + 200
                },
                {
                    id: 'T11002',
                    nome: 'Trem Local 002',
                    direcao: 'Sentido Corinthians-Itaquera',
                    currentStationIndex: Math.floor(line11Stations.length / 2),
                    targetStationIndex: Math.floor(line11Stations.length / 2) + 1,
                    progress: 0.5,
                    speed: 0.015,
                    lotacao: 'Alta',
                    status: 'Em movimento',
                    nextArrival: '4 min',
                    passageiros: Math.floor(Math.random() * 1200) + 800
                },
                {
                    id: 'T11003',
                    nome: 'Trem Expresso 003',
                    direcao: 'Sentido Luz',
                    currentStationIndex: line11Stations.length - 2,
                    targetStationIndex: line11Stations.length - 1,
                    progress: 0.3,
                    speed: 0.025,
                    lotacao: 'Baixa',
                    status: 'Chegando',
                    nextArrival: '1 min',
                    passageiros: Math.floor(Math.random() * 400) + 100
                }
            ];
        }

        function updateLine11Trains() {
            const line11Stations = ORDEM_ESTACOES['11'].map(nomeEstacao => {
                const estacao = ESTACOES_CPTM[nomeEstacao];
                return {
                    nome: nomeEstacao,
                    lat: estacao.lat,
                    lng: estacao.lng,
                    cor: estacao.cor
                };
            });

            // Remover marcadores antigos
            line11TrainMarkers.forEach(marker => marker.setMap(null));
            line11TrainMarkers = [];

            line11Trains.forEach((trem, index) => {
                // Atualizar progresso do trem
                trem.progress += trem.speed;

                // Se chegou à próxima estação
                if (trem.progress >= 1) {
                    trem.currentStationIndex = trem.targetStationIndex;
                    trem.progress = 0;

                    // Definir próxima estação
                    if (trem.direcao === 'Sentido Corinthians-Itaquera') {
                        trem.targetStationIndex = Math.min(trem.currentStationIndex + 1, line11Stations.length - 1);

                        // Se chegou ao final, inverter direção
                        if (trem.targetStationIndex === line11Stations.length - 1) {
                            trem.direcao = 'Sentido Luz';
                        }
                    } else {
                        trem.targetStationIndex = Math.max(trem.currentStationIndex - 1, 0);

                        // Se chegou ao início, inverter direção
                        if (trem.targetStationIndex === 0) {
                            trem.direcao = 'Sentido Corinthians-Itaquera';
                        }
                    }

                    // Simular parada na estação
                    trem.status = 'Parado na estação';
                    setTimeout(() => {
                        trem.status = 'Em movimento';
                        // Atualizar dados aleatórios
                        updateTrainData(trem);
                    }, 3000);
                }

                // Calcular posição atual do trem (interpolação entre estações)
                const currentStation = line11Stations[trem.currentStationIndex];
                const targetStation = line11Stations[trem.targetStationIndex];

                if (currentStation && targetStation) {
                    const lat = currentStation.lat + (targetStation.lat - currentStation.lat) * trem.progress;
                    const lng = currentStation.lng + (targetStation.lng - currentStation.lng) * trem.progress;

                    // Criar marcador do trem
                    const trainMarker = new google.maps.Marker({
                        position: { lat, lng },
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#FF6B35', // Cor coral para Linha 11
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        },
                        title: `${trem.nome} - ${trem.status}`,
                        zIndex: 1000
                    });

                    // Popup do trem com informações detalhadas
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="max-width: 300px; padding: 15px;">
                                <h3 style="margin: 0 0 10px 0; color: #FF6B35;">
                                    🚊 ${trem.nome}
                                </h3>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="margin: 5px 0;"><strong>Direção:</strong> ${trem.direcao}</p>
                                    <p style="margin: 5px 0;"><strong>Status:</strong> 
                                        <span style="color: ${getStatusColor(trem.status)};">● ${trem.status}</span>
                                    </p>
                                    <p style="margin: 5px 0;"><strong>Lotação:</strong> 
                                        <span style="color: ${getLotacaoColor(trem.lotacao)};">● ${trem.lotacao}</span>
                                    </p>
                                    <p style="margin: 5px 0;"><strong>Passageiros:</strong> ~${trem.passageiros}</p>
                                    <p style="margin: 5px 0;"><strong>Próxima chegada:</strong> ${trem.nextArrival}</p>
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    <p style="margin: 5px 0;">📍 Entre: ${currentStation.nome} → ${targetStation.nome}</p>
                                    <p style="margin: 5px 0;">📊 Progresso: ${Math.round(trem.progress * 100)}%</p>
                                </div>
                            </div>
                        `
                    });

                    trainMarker.addListener('click', () => {
                        infoWindow.open(map, trainMarker);
                    });

                    line11TrainMarkers.push(trainMarker);
                }
            });

            // Atualizar notificações com status dos trens
            updateLine11Notifications();
        }

        function updateTrainData(trem) {
            // Simular mudanças nos dados do trem
            const lotacoes = ['Baixa', 'Média', 'Alta'];
            trem.lotacao = lotacoes[Math.floor(Math.random() * lotacoes.length)];

            const basePassageiros = trem.lotacao === 'Baixa' ? 200 : trem.lotacao === 'Média' ? 600 : 1000;
            trem.passageiros = Math.floor(Math.random() * 400) + basePassageiros;

            const arrivalTimes = ['1 min', '2 min', '3 min', '4 min', '5 min'];
            trem.nextArrival = arrivalTimes[Math.floor(Math.random() * arrivalTimes.length)];
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Em movimento': return '#22c55e';
                case 'Parado na estação': return '#f59e0b';
                case 'Chegando': return '#3b82f6';
                default: return '#6b7280';
            }
        }

        function getLotacaoColor(lotacao) {
            switch (lotacao) {
                case 'Baixa': return '#22c55e';
                case 'Média': return '#f59e0b';
                case 'Alta': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function updateLine11Notifications() {
            // Atualizar painel de notificações com status dos trens da Linha 11
            const notifications = line11Trains.map(trem => {
                const currentStation = ORDEM_ESTACOES['11'][trem.currentStationIndex];
                const targetStation = ORDEM_ESTACOES['11'][trem.targetStationIndex];

                return `
                    <div class="notification-item">
                        <h4>🚊 ${trem.nome}</h4>
                        <p>${trem.status} - ${trem.direcao}</p>
                        <p>📍 ${currentStation} → ${targetStation}</p>
                        <p>👥 Lotação: ${trem.lotacao} (~${trem.passageiros} passageiros)</p>
                        <small>Próxima chegada: ${trem.nextArrival}</small>
                    </div>
                `;
            }).join('');

            const panel = document.getElementById('notificationsList');
            if (panel) {
                panel.innerHTML = `
                    <div class="notification-item" style="background: linear-gradient(135deg, #FF6B35, #FF8E53); color: white;">
                        <h4>🚊 Linha 11-Coral - Tempo Real</h4>
                        <p>Monitoramento ativo de ${line11Trains.length} trens</p>
                        <small>Atualização automática a cada 2 segundos</small>
                    </div>
                    ${notifications}
                `;
            }
        }

        function updateLineIndicators() {
            const indicators = document.querySelectorAll('.linha-indicator');
            indicators.forEach(indicator => {
                const cor = indicator.getAttribute('data-cor');
                if (cor) {
                    indicator.style.background = `linear-gradient(135deg, ${cor}, ${cor}dd)`;
                }
            });
        }

        function updateClimateInfo() {
            const climaCard = document.getElementById('climaCard');
            if (climaData && climaCard) {
                const iconClass = getWeatherIcon(climaData.condicao);
                climaCard.innerHTML = `
                    <div class="clima-icon">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="clima-info">
                        <h3>${climaData.temperatura}°C</h3>
                        <p>${climaData.descricao}</p>
                    </div>
                `;
            }
        }

        function updateTrainMarker(trem) {
            if (!trem || typeof trem.latitude !== 'number' || typeof trem.longitude !== 'number' ||
                isNaN(trem.latitude) || isNaN(trem.longitude)) {
                return;
            }

            const marker = trainMarkers[trem.id];
            if (marker) {
                marker.setPosition({ lat: trem.latitude, lng: trem.longitude });

                // Atualizar ícone se necessário
                const cor = CORES_LINHAS[trem.linha] || '#3498db';
                marker.setIcon({
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 6,
                    fillColor: cor,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    rotation: trem.direcao_graus || 0
                });
            } else {
                addTrainMarker(trem);
            }
        }

        function startDataRefresh() {
            refreshAllData();
            setInterval(refreshAllData, 15000);

            setInterval(() => {
                fetch('/api/trens/')
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.trens && Array.isArray(data.trens)) {
                            data.trens.forEach(trem => {
                                if (trem && trem.id &&
                                    typeof trem.latitude === 'number' &&
                                    typeof trem.longitude === 'number' &&
                                    !isNaN(trem.latitude) && !isNaN(trem.longitude)) {
                                    updateTrainMarker(trem);
                                }
                            });
                        }
                    })
                    .catch(error => {/* Erro silencioso */ });
            }, 5000);
        }

        // ========== UI HELPERS ==========
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };

            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                max-width: 350px;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.23, 1, 0.320, 1);
                font-family: 'Inter', sans-serif;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function handleResize() {
            if (map) {
                google.maps.event.trigger(map, 'resize');
            }
        }

        // Utility functions
        function getStatusColor(status) {
            const colors = {
                'operacional': '#10b981',
                'atrasado': '#f59e0b',
                'em_manutencao': '#ef4444',
                'fora_de_servico': '#6b7280'
            };
            return colors[status] || '#6b7280';
        }

        function getLotacaoColor(lotacao) {
            const colors = {
                'baixa': '#10b981',
                'media': '#f59e0b',
                'alta': '#ef4444',
                'superlotado': '#8b5cf6'
            };
            return colors[lotacao] || '#6b7280';
        }

        function getWeatherIcon(condicao) {
            const icons = {
                'clear': 'fa-sun',
                'clouds': 'fa-cloud',
                'rain': 'fa-cloud-rain',
                'drizzle': 'fa-cloud-drizzle',
                'thunderstorm': 'fa-bolt',
                'snow': 'fa-snowflake',
                'mist': 'fa-smog'
            };
            return icons[condicao] || 'fa-cloud';
        }

        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        }

        // Callback para Google Maps API
        // Removed duplicate window.initMap assignment
    </script>

    <script>
        // Inicialização
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
            connectWebSocket();
            updateClimateInfo();
            startDataRefresh();
        });

        function initializeApp() {
            console.log('🚀 Inicializando aplicação CPTM Tracker...');
            showLoading();

            // Usar diretamente Leaflet (mais rápido e gratuito)
            initLeafletMapComplete();

            setTimeout(hideLoading, 2000);
        }

        // Nova função completa para inicializar Leaflet com todas as funcionalidades
        function initLeafletMapComplete() {
            console.log('🍃 Inicializando sistema completo com Leaflet...');

            // Verificar se o mapa já foi inicializado
            if (window.map && window.map.remove) {
                console.log('🔄 Removendo mapa existente...');
                window.map.remove();
            }

            try {
                // Criar mapa Leaflet centrado em São Paulo
                window.map = L.map('map').setView([-23.5505, -46.6333], 11);

                // Adicionar tiles do OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(window.map);

                // Criar camada para marcadores
                window.markerLayer = L.layerGroup().addTo(window.map);

                // Inicializar trajetos das linhas
                initLineTrajectories();

                // Desenhar linhas dinâmicas baseadas nas estações
                drawDynamicLines();

                // Adicionar estações como pontos de controle
                if (estacoes && Array.isArray(estacoes)) {
                    estacoes.forEach(addStationControlPoint);
                }

                // Adicionar trens se existirem
                if (trens && Array.isArray(trens)) {
                    trens.forEach(addTrainMarker);
                }

                // Adicionar controle de localização
                const locateControl = L.control({ position: 'topleft' });
                locateControl.onAdd = function () {
                    const div = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar leaflet-control');
                    div.innerHTML = '<a href="#" title="Localizar-me" onclick="locateUser(); return false;">📍</a>';
                    return div;
                };
                locateControl.addTo(window.map);

                // Armazenar referências globais
                window.stationMarkers = {};
                window.currentMap = window.map;

                console.log('✅ Sistema Leaflet inicializado com sucesso!');
                showNotification('🗺️ Mapa carregado com sucesso!', 'success');

            } catch (error) {
                console.error('💥 Erro ao inicializar Leaflet:', error);
                showNotification('❌ Erro ao carregar mapa', 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('notificationToggle').addEventListener('click', toggleNotifications);
            document.getElementById('refreshData').addEventListener('click', refreshAllData);
        }

        function initLeafletMapSimple() {
            // Verificar se o mapa já foi inicializado
            if (map && map.remove) {
                console.log('🍃 Mapa Leaflet já inicializado, removendo instância anterior...');
                map.remove();
            }

            // Criar mapa Leaflet centrado em São Paulo
            map = L.map('map').setView([-23.5505, -46.6333], 11);

            // Adicionar tiles do OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetMap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Criar camada para marcadores
            markerLayer = L.layerGroup().addTo(map);

            // Inicializar trajetos das linhas
            initLineTrajectories();

            // Adicionar estações como pontos de controle
            estacoes.forEach(addStationControlPoint);

            // Adicionar trens
            trens.forEach(addTrainMarker);

            // Desenhar linhas dinâmicas baseadas nas estações
            try {
                if (typeof generateDynamicLines === 'function') {
                    drawDynamicLines();
                }
            } catch (error) {
                // Erro silencioso - não precisa notificar
            }

            // Adicionar controle de localização
            const locateControl = L.control({ position: 'topleft' });
            locateControl.onAdd = function () {
                const div = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar leaflet-control');
                div.innerHTML = '<a href="#" title="Localizar-me" onclick="locateUser(); return false;">📍</a>';
                return div;
            };
            locateControl.addTo(map);

            // Armazenar referências para uso global
            window.stationMarkers = {};
        }

        function addStationMarker(estacao) {
            // Validar se a estação tem coordenadas válidas
            if (!estacao || typeof estacao.latitude !== 'number' || typeof estacao.longitude !== 'number' ||
                isNaN(estacao.latitude) || isNaN(estacao.longitude)) {
                console.log('Não é possível adicionar estação com coordenadas inválidas:', estacao);
                return; // Não adicionar esta estação
            }

            // Criar ícone personalizado para estação
            const stationIcon = L.divIcon({
                html: `<div class="station-icon" style="background-color: ${estacao.linha_cor || '#666'};"></div>`,
                className: 'custom-station-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            const marker = L.marker([estacao.latitude, estacao.longitude], {
                icon: stationIcon,
                title: estacao.nome
            }).addTo(markerLayer);

            marker.bindPopup(`
                <div class="popup-content">
                    <h3 class="popup-title" style="color: ${estacao.linha_cor || '#666'};">
                        ${estacao.nome}
                    </h3>
                    <p><strong>Linha:</strong> ${estacao.linha_nome || 'N/A'}</p>
                    <p><strong>Acessibilidade:</strong> ${estacao.acessivel ? '✓ Acessível' : '✗ Não acessível'}</p>
                    ${estacao.tem_elevador ? '<p>🛗 Elevador disponível</p>' : ''}
                    ${estacao.tem_escada_rolante ? '<p>🔄 Escada rolante</p>' : ''}
                    <button class="popup-button" onclick="showStationSchedule(${estacao.id})" 
                            style="background: ${estacao.linha_cor || '#666'};">
                        Ver Horários
                    </button>
                </div>
            `);

            markers[estacao.id] = marker;
        }

        function addTrainMarker(trem) {
            // Validar se o trem tem coordenadas válidas
            if (!trem || typeof trem.latitude !== 'number' || typeof trem.longitude !== 'number' ||
                isNaN(trem.latitude) || isNaN(trem.longitude)) {
                console.log('Não é possível adicionar trem com coordenadas inválidas:', trem);
                return; // Não adicionar este trem
            }

            // Criar ícone personalizado para trem
            const trainIcon = L.divIcon({
                html: `<div class="train-icon" style="background-color: ${trem.linha_cor || '#3498db'};">🚆</div>`,
                className: 'custom-train-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            const marker = L.marker([trem.latitude, trem.longitude], {
                icon: trainIcon,
                title: `Trem ${trem.identificador}`,
                zIndexOffset: 1000
            }).addTo(markerLayer);

            const statusColor = getStatusColor(trem.status);
            const lotacaoColor = getLotacaoColor(trem.lotacao);

            marker.bindPopup(`
                <div class="popup-content-train">
                    <h3 class="popup-title" style="color: ${trem.linha_cor || '#3498db'};">
                        Trem ${trem.identificador}
                    </h3>
                    <p><strong>Linha:</strong> ${trem.linha_nome || 'N/A'}</p>
                    <p><strong>Status:</strong> <span class="status-indicator" style="color: ${statusColor};">● ${trem.status || 'N/A'}</span></p>
                    <p><strong>Lotação:</strong> <span class="status-indicator" style="color: ${lotacaoColor};">● ${trem.lotacao || 'N/A'}</span></p>
                    <p><strong>Velocidade:</strong> ${trem.velocidade || 0} km/h</p>
                    <p><strong>Direção:</strong> ${trem.direcao || 'N/A'}</p>
                    <p><strong>Estação atual:</strong> ${trem.estacao_atual || 'N/A'}</p>
                    <p><strong>Próxima estação:</strong> ${trem.proxima_estacao || 'N/A'}</p>
                    ${trem.previsao_chegada ? `<p><strong>Previsão:</strong> ${formatTime(trem.previsao_chegada)}</p>` : ''}
                </div>
            `);

            trainMarkers[trem.id] = marker;
        }

        function showStationInfo(estacao, marker) {
            const content = `
                <div style="padding: 10px; max-width: 300px;">
                    <h3 style="margin: 0 0 10px 0; color: ${estacao.linha_cor};">
                        ${estacao.nome}
                    </h3>
                    <p><strong>Linha:</strong> ${estacao.linha_nome}</p>
                    <p><strong>Acessibilidade:</strong> ${estacao.acessivel ? '✓ Acessível' : '✗ Não acessível'}</p>
                    ${estacao.tem_elevador ? '<p>🛗 Elevador disponível</p>' : ''}
                    ${estacao.tem_escada_rolante ? '<p>🔄 Escada rolante</p>' : ''}
                    <button onclick="showStationSchedule(${estacao.id})" 
                            style="background: ${estacao.linha_cor}; color: white; border: none; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        Ver Horários
                    </button>
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({ content });
            infoWindow.open(map, marker);
        }

        function showTrainInfo(trem, marker) {
            const statusColor = getStatusColor(trem.status);
            const lotacaoColor = getLotacaoColor(trem.lotacao);

            const content = `
                <div style="padding: 10px; max-width: 300px;">
                    <h3 style="margin: 0 0 10px 0; color: ${trem.linha_cor};">
                        Trem ${trem.identificador}
                    </h3>
                    <p><strong>Linha:</strong> ${trem.linha_nome}</p>
                    <p><strong>Status:</strong> <span style="color: ${statusColor};">● ${trem.status}</span></p>
                    <p><strong>Lotação:</strong> <span style="color: ${lotacaoColor};">● ${trem.lotacao}</span></p>
                    <p><strong>Velocidade:</strong> ${trem.velocidade} km/h</p>
                    <p><strong>Direção:</strong> ${trem.direcao}</p>
                    <p><strong>Estação atual:</strong> ${trem.estacao_atual}</p>
                    <p><strong>Próxima estação:</strong> ${trem.proxima_estacao}</p>
                    ${trem.previsao_chegada ? `<p><strong>Previsão:</strong> ${formatTime(trem.previsao_chegada)}</p>` : ''}
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({ content });
            infoWindow.open(map, marker);
        }

        function connectWebSocket() {
            // WebSocket temporariamente desabilitado - Sistema otimizado via REST API
            // Sistema operacional otimizado
            showNotification('Sistema em tempo real via API ativo!', 'success');

            // Sistema já funciona perfeitamente com atualizações frequentes
            // WebSocket será reativado em versão futura se necessário
            return;

            /*
            // Código WebSocket comentado para evitar erros 404
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/trens/`;
            
            try {
                websocket = new WebSocket(wsUrl);
                // ... código WebSocket ...
            } catch (error) {
                console.log('WebSocket não disponível, usando API REST');
            }
            */
        }

        function handleRealtimeUpdate(data) {
            if (data.type === 'trem_update') {
                console.log('Atualizando posição do trem via WebSocket:', data.data);
                updateTrainMarker(data.data);
            } else if (data.type === 'linha_update') {
                console.log('Atualizando status da linha via WebSocket:', data.data);
                updateLineStatus(data.data);
            }
        }

        function updateClimateInfo(novosDados = null) {
            console.log('🌤️ Atualizando informações climáticas...');

            // Se novos dados foram fornecidos, atualizar a variável global
            if (novosDados) {
                climaData = novosDados;
            }

            const climaCard = document.getElementById('climaCard');
            if (!climaCard) {
                console.warn('⚠️ Elemento climaCard não encontrado');
                return;
            }

            if (climaData && typeof climaData === 'object') {
                const iconClass = getWeatherIcon(climaData.condicao || 'clear');
                const temperatura = climaData.temperatura || '25';
                const descricao = climaData.descricao || 'Condições normais';

                climaCard.innerHTML = `
                    <div class="clima-icon">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="clima-info">
                        <h3>${temperatura}°C</h3>
                        <p>${descricao}</p>
                        <small>São Paulo • Atualizado agora</small>
                    </div>
                `;

                console.log(`✅ Clima atualizado: ${temperatura}°C - ${descricao}`);
            } else {
                // Fallback se não há dados disponíveis
                climaCard.innerHTML = `
                    <div class="clima-icon">
                        <i class="fas fa-cloud"></i>
                    </div>
                    <div class="clima-info">
                        <h3>--°C</h3>
                        <p>Carregando...</p>
                        <small>Aguardando dados...</small>
                    </div>
                `;
                console.log('⚠️ Dados climáticos não disponíveis, usando fallback');
            }

            // Buscar dados atualizados da API do clima
            fetchRealTimeWeather();
        }

        // Nova função para buscar clima em tempo real
        function fetchRealTimeWeather() {
            console.log('🌡️ Buscando dados climáticos em tempo real...');

            fetch('/api/clima/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.clima) {
                        console.log('📡 Dados climáticos recebidos:', data.clima);

                        // Atualizar dados globais com os dados da API
                        climaData = {
                            temperatura: data.clima.temperatura,
                            condicao: data.clima.condicao,
                            descricao: data.clima.descricao || 'Condições atuais',
                            ultima_atualizacao: new Date().toISOString()
                        };

                        // Atualizar a interface sem chamar updateClimateInfo novamente (evitar loop)
                        const climaCard = document.getElementById('climaCard');
                        if (climaCard) {
                            const iconClass = getWeatherIcon(climaData.condicao);
                            climaCard.innerHTML = `
                                <div class="clima-icon">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div class="clima-info">
                                    <h3>${climaData.temperatura}°C</h3>
                                    <p>${climaData.descricao}</p>
                                    <small>São Paulo • ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</small>
                                </div>
                            `;
                        }

                        console.log(`✅ Clima atualizado em tempo real: ${climaData.temperatura}°C`);
                    } else {
                        console.warn('⚠️ Estrutura de dados climáticos inesperada:', data);
                    }
                })
                .catch(error => {
                    console.warn('⚠️ Erro ao buscar dados climáticos:', error.message);

                    // Manter os dados atuais se falhar a busca
                    if (!climaData || typeof climaData !== 'object') {
                        climaData = {
                            temperatura: '25',
                            condicao: 'clear',
                            descricao: 'Dados indisponíveis',
                            ultima_atualizacao: new Date().toISOString()
                        };
                    }
                });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('themeToggle').innerHTML =
                `<i class="fas ${isDark ? 'fa-sun' : 'fa-moon'}"></i>`;

            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Aplicar tema escuro ao mapa Leaflet
            if (isDark) {
                // Trocar para tiles escuros
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© OpenStreetMap contributors, © CARTO'
                }).addTo(map);
            } else {
                // Voltar para tiles normais
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const isMobile = window.innerWidth <= 768;

            sidebar.classList.toggle('open');

            if (isMobile) {
                mobileOverlay.classList.toggle('show');

                // Fechar sidebar ao clicar no overlay
                mobileOverlay.onclick = () => {
                    sidebar.classList.remove('open');
                    mobileOverlay.classList.remove('show');
                };

                // Prevenir scroll do body quando sidebar está aberta
                if (sidebar.classList.contains('open')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        function toggleNotifications() {
            const notificationPanel = document.getElementById('notificationPanel');
            const isMobile = window.innerWidth <= 768;

            notificationPanel.classList.toggle('open');

            if (isMobile && notificationPanel.classList.contains('open')) {
                // Fechar outras panels se estiverem abertas
                const sidebar = document.getElementById('sidebar');
                const mobileOverlay = document.getElementById('mobileOverlay');

                sidebar.classList.remove('open');
                mobileOverlay.classList.remove('show');

                // Prevenir scroll do body
                document.body.style.overflow = 'hidden';

                // Fechar ao clicar fora (simulado)
                setTimeout(() => {
                    const clickOutsideHandler = (e) => {
                        if (!notificationPanel.contains(e.target) &&
                            !e.target.closest('#notificationToggle')) {
                            notificationPanel.classList.remove('open');
                            document.body.style.overflow = '';
                            document.removeEventListener('click', clickOutsideHandler);
                        }
                    };
                    document.addEventListener('click', clickOutsideHandler);
                }, 100);
            } else if (!notificationPanel.classList.contains('open')) {
                document.body.style.overflow = '';
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function updateTrainMarker(trem) {
            // Validar se o trem tem coordenadas válidas
            if (!trem || typeof trem.latitude !== 'number' || typeof trem.longitude !== 'number' ||
                isNaN(trem.latitude) || isNaN(trem.longitude)) {
                console.log('Trem com coordenadas inválidas:', trem);
                return; // Pular este trem
            }

            const marker = trainMarkers[trem.id];
            if (marker) {
                // Atualizar posição
                marker.setLatLng([trem.latitude, trem.longitude]);

                // Atualizar ícone baseado no status
                const trainIcon = L.divIcon({
                    html: `<div style="background-color: ${trem.linha_cor || '#3498db'}; color: white; width: 20px; height: 20px; border-radius: 4px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">🚆</div>`,
                    className: 'custom-train-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                marker.setIcon(trainIcon);
            } else {
                // Criar novo marcador se não existir
                addTrainMarker(trem);
            }
        }

        function refreshAllData() {
            console.log('🔄 Iniciando atualização completa dos dados...');
            showLoading();

            // Atualizar dados via API
            Promise.all([
                fetch('/api/trens/').then(r => r.json()),
                fetch('/api/clima/').then(r => r.json())
            ]).then(([tremsData, climaData]) => {
                console.log('📡 Dados recebidos:', {
                    trens: tremsData?.trens?.length || 0,
                    clima: climaData?.clima?.temperatura
                });

                // Atualizar marcadores de trens
                if (tremsData && tremsData.trens && Array.isArray(tremsData.trens)) {
                    tremsData.trens.forEach(trem => {
                        // Validar cada trem antes de tentar atualizar
                        if (trem && trem.id) {
                            updateTrainMarker(trem);
                        }
                    });
                    console.log(`✅ ${tremsData.trens.length} trens atualizados`);
                } else {
                    console.warn('⚠️ Dados de trens inválidos:', tremsData);
                }

                // Atualizar informações climáticas com novos dados
                if (climaData && climaData.clima) {
                    updateClimateInfo(climaData.clima);
                    console.log(`🌤️ Clima atualizado: ${climaData.clima.temperatura}°C`);
                } else {
                    console.warn('⚠️ Dados climáticos inválidos:', climaData);
                    // Tentar atualizar clima mesmo sem dados novos
                    updateClimateInfo();
                }

                hideLoading();
                showNotification('✅ Todos os dados atualizados com sucesso!', 'success');

            }).catch(error => {
                hideLoading();
                showNotification('❌ Erro ao atualizar dados', 'error');
                console.error('💥 Erro detalhado na atualização:', error);

                // Tentar atualizar clima independentemente
                updateClimateInfo();
            });
        }

        function startDataRefresh() {
            console.log('🔄 Iniciando sistema de atualização automática...');

            // Primeira atualização imediata
            refreshAllData();

            // Atualizar dados completos a cada 30 segundos (evitar sobrecarga)
            setInterval(() => {
                console.log('⏰ Atualização automática programada...');
                refreshAllData();
            }, 30000);

            // Atualizar apenas clima a cada 2 minutos (dados climáticos mudam menos)
            setInterval(() => {
                console.log('🌡️ Atualização automática do clima...');
                fetchRealTimeWeather();
            }, 120000);

            // Atualizar apenas posições dos trens a cada 5 segundos (mais crítico)
            setInterval(() => {
                fetch('/api/trens/')
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.trens && Array.isArray(data.trens)) {
                            data.trens.forEach(trem => {
                                // Validar cada trem antes de tentar atualizar
                                if (trem && trem.id &&
                                    typeof trem.latitude === 'number' &&
                                    typeof trem.longitude === 'number' &&
                                    !isNaN(trem.latitude) && !isNaN(trem.longitude)) {
                                    updateTrainMarker(trem);
                                }
                            });
                        }
                    })
                    .catch(error => console.log('Erro silencioso ao atualizar trens:', error));
            }, 5000);

            console.log('✅ Sistema de atualização automática ativo!');
        }

        function getMapStyles() {
            const isDark = document.body.classList.contains('dark');
            return isDark ? [
                { elementType: 'geometry', stylers: [{ color: '#212121' }] },
                { elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
                { elementType: 'labels.text.fill', stylers: [{ color: '#757575' }] },
                { elementType: 'labels.text.stroke', stylers: [{ color: '#212121' }] },
                { featureType: 'administrative', elementType: 'geometry', stylers: [{ color: '#757575' }] },
                { featureType: 'administrative.country', elementType: 'labels.text.fill', stylers: [{ color: '#9e9e9e' }] },
                { featureType: 'administrative.land_parcel', stylers: [{ visibility: 'off' }] },
                { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#bdbdbd' }] },
                { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#757575' }] },
                { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#181818' }] },
                { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#616161' }] },
                { featureType: 'poi.park', elementType: 'labels.text.stroke', stylers: [{ color: '#1b1b1b' }] },
                { featureType: 'road', elementType: 'geometry.fill', stylers: [{ color: '#2c2c2c' }] },
                { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#8a8a8a' }] },
                { featureType: 'road.arterial', elementType: 'geometry', stylers: [{ color: '#373737' }] },
                { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#3c3c3c' }] },
                { featureType: 'road.highway.controlled_access', elementType: 'geometry', stylers: [{ color: '#4e4e4e' }] },
                { featureType: 'road.local', elementType: 'labels.text.fill', stylers: [{ color: '#616161' }] },
                { featureType: 'transit', elementType: 'labels.text.fill', stylers: [{ color: '#757575' }] },
                { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#000000' }] },
                { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#3d3d3d' }] }
            ] : [];
        }

        function getStatusColor(status) {
            const colors = {
                'operacional': '#2ecc71',
                'atrasado': '#f39c12',
                'em_manutencao': '#e74c3c',
                'fora_de_servico': '#95a5a6'
            };
            return colors[status] || '#95a5a6';
        }

        function getLotacaoColor(lotacao) {
            const colors = {
                'baixa': '#2ecc71',
                'media': '#f39c12',
                'alta': '#e74c3c',
                'superlotado': '#8e44ad'
            };
            return colors[lotacao] || '#95a5a6';
        }

        function getWeatherIcon(condicao) {
            const icons = {
                'clear': 'fa-sun',
                'clouds': 'fa-cloud',
                'rain': 'fa-cloud-rain',
                'drizzle': 'fa-cloud-drizzle',
                'thunderstorm': 'fa-bolt',
                'snow': 'fa-snowflake',
                'mist': 'fa-smog'
            };
            return icons[condicao] || 'fa-cloud';
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function centerMap() {
            map.setView([-23.5505, -46.6333], 11);
        }

        function toggleTraffic() {
            // Funcionalidade de trânsito não disponível no OpenStreetMap básico
            showNotification('Informações de trânsito não disponíveis', 'info');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function focusOnLine(lineNumber) {
            console.log(`🎯 focusOnLine (Leaflet) chamado para linha: ${lineNumber}`);

            // Implementar foco na linha específica
            const lineTrains = trens.filter(t => t.linha === lineNumber);
            if (lineTrains.length > 0) {
                const group = new L.featureGroup();
                lineTrains.forEach(train => {
                    const marker = trainMarkers[train.id];
                    if (marker) {
                        group.addLayer(marker);
                    }
                });
                if (group.getLayers().length > 0) {
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            } else {
                // Se não há trens, focar nas estações da linha
                console.log(`🚉 Tentando focar nas estações da linha ${lineNumber}`);
                const stationsOfLine = Object.entries(ESTACOES_CPTM || {})
                    .filter(([nome, dados]) => dados.linha === lineNumber)
                    .map(([nome, dados]) => [dados.lat, dados.lng]);

                if (stationsOfLine.length > 0) {
                    console.log(`🚉 Focando em ${stationsOfLine.length} estações da linha ${lineNumber}`);
                    const group = new L.featureGroup();
                    stationsOfLine.forEach(coord => {
                        L.marker(coord).addTo(group);
                    });
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            // Funcionalidade especial para Linha 11 - Coral
            if (lineNumber === '11') {
                console.log(`🚊 Iniciando simulação para Linha 11-Coral`);
                showNotification(`🚊 Iniciando simulação em tempo real da ${getLineName(lineNumber)}`, 'success');
                startLine11RealTimeSimulation();
            } else {
                showNotification(`Focalizando ${getLineName(lineNumber)}`, 'info');
            }
        }

        function showStationSchedule(stationId) {
            fetch(`/api/estacao/${stationId}/previsao/`)
                .then(response => response.json())
                .then(data => {
                    // Mostrar horários em modal ou painel
                    console.log('Horários da estação:', data);
                });
        }

        function showNotification(message, type = 'info') {
            // Criar notificação visual no topo da tela
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'success' ? '#2ecc71' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Animar entrada
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remover após 3 segundos
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);

            console.log(`${type}: ${message}`);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showStationSchedule(stationId) {
            fetch(`/api/estacao/${stationId}/previsao/`)
                .then(response => response.json())
                .then(data => {
                    // Mostrar horários em modal ou painel
                    console.log('Horários da estação:', data);
                    showNotification('Dados da estação carregados', 'success');
                });
        }

        function getStatusColor(status) {
            const colors = {
                'operacional': '#2ecc71',
                'atrasado': '#f39c12',
                'em_manutencao': '#e74c3c',
                'fora_de_servico': '#95a5a6'
            };
            return colors[status] || '#95a5a6';
        }

        function getLotacaoColor(lotacao) {
            const colors = {
                'baixa': '#2ecc71',
                'media': '#f39c12',
                'alta': '#e74c3c',
                'superlotado': '#8e44ad'
            };
            return colors[lotacao] || '#95a5a6';
        }

        function getWeatherIcon(condicao) {
            const icons = {
                'clear': 'fa-sun',
                'clouds': 'fa-cloud',
                'rain': 'fa-cloud-rain',
                'drizzle': 'fa-cloud-drizzle',
                'thunderstorm': 'fa-bolt',
                'snow': 'fa-snowflake',
                'mist': 'fa-smog'
            };
            return icons[condicao] || 'fa-cloud';
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ========== NOVAS FUNÇÕES PARA TRAJETOS E PONTOS DE CONTROLE ==========

        // === SISTEMA DINÂMICO DE GERAÇÃO DE LINHAS ===

        function generateDynamicLines() {
            console.log('🚇 Gerando linhas dinâmicas baseadas nas estações...');

            // Ordenação das estações por linha seguindo a sequência geográfica real
            const ORDEM_ESTACOES = {
                '7': [
                    'Luz', 'Palmeiras–Barra Funda', 'Água Branca', 'Lapa', 'Piqueri',
                    'Pirituba', 'Vila Clarice', 'Jaraguá', 'Perus', 'Caieiras',
                    'Franco da Rocha', 'Baltazar Fidélis', 'Francisco Morato',
                    'Botujuru', 'Campo Limpo Paulista', 'Várzea Paulista', 'Jundiaí'
                ],
                '8': [
                    'Júlio Prestes', 'Domingos de Moraes', 'Imperatriz Leopoldina',
                    'Presidente Altino', 'Osasco', 'Comandante Sampaio', 'Quitaúna',
                    'General Miguel Costa', 'Carapicuíba', 'Santa Terezinha',
                    'Antônio João', 'Barueri', 'Jardim Belval', 'Jardim Silveira',
                    'Jandira', 'Sagrado Coração', 'Engenheiro Cardoso', 'Itapevi',
                    'Santa Rita', 'Cimenrita', 'Ambuitá', 'Amador Bueno'
                ],
                '9': [
                    'Osasco', 'Ceasa', 'Villa Lobos–Jaguaré', 'Cidade Universitária',
                    'Pinheiros', 'Hebraica–Rebouças', 'Cidade Jardim', 'Vila Olímpia',
                    'Berrini', 'Morumbi', 'Granja Julieta', 'João Dias', 'Santo Amaro',
                    'Socorro', 'Jurubatuba', 'Autódromo', 'Primavera–Interlagos',
                    'Grajaú', 'Bruno Covas/Mendes–Vila Natal'
                ],
                '10': [
                    'Luz', 'Brás', 'Juventus–Mooca', 'Ipiranga', 'Tamanduateí',
                    'São Caetano do Sul–Prefeito Walter Braido', 'Utinga',
                    'Prefeito Saladino', 'Prefeito Celso Daniel–Santo André', 'Capuava',
                    'Mauá', 'Guapituba', 'Ribeirão Pires–Antônio Bespalec', 'Rio Grande da Serra'
                ],
                '11': [
                    'Palmeiras–Barra Funda', 'Luz', 'Brás', 'Tatuapé', 'Corinthians–Itaquera',
                    'Dom Bosco', 'José Bonifácio', 'Guaianases', 'Antonio Gianetti Neto',
                    'Ferraz de Vasconcelos', 'Poá', 'Suzano', 'Calmon Viana', 'Jundiapeba',
                    'Brás Cubas', 'Mogi das Cruzes', 'Estudantes'
                ],
                '12': [
                    'Brás', 'Engenheiro Goulart', 'USP Leste', 'Comendador Ermelino',
                    'São Miguel Paulista', 'Jardim Helena–Vila Mara', 'Itaim Paulista',
                    'Jardim Romano', 'Engenheiro Manoel Feio', 'Itaquaquecetuba',
                    'Aracaré', 'Calmon Viana'
                ],
                '13': [
                    'Engenheiro Goulart', 'Guarulhos–Cecap'
                ]
            };

            // Agrupar estações por linha com ordenação correta
            const linhasOrdenadas = {};

            Object.entries(ORDEM_ESTACOES).forEach(([numeroLinha, ordemEstacoes]) => {
                const coordenadasLinha = [];
                const estacoesLinha = [];

                ordemEstacoes.forEach(nomeEstacao => {
                    const dadosEstacao = ESTACOES_CPTM[nomeEstacao];
                    if (dadosEstacao && dadosEstacao.linha === numeroLinha) {
                        coordenadasLinha.push([dadosEstacao.lat, dadosEstacao.lng]);
                        estacoesLinha.push({
                            nome: nomeEstacao,
                            ...dadosEstacao
                        });
                        console.log(`✅ Adicionada estação ${nomeEstacao} à linha ${numeroLinha}`);
                    } else {
                        console.warn(`⚠️ Estação ${nomeEstacao} não encontrada ou linha incorreta para linha ${numeroLinha}`);
                    }
                });

                if (coordenadasLinha.length > 1) {
                    linhasOrdenadas[numeroLinha] = {
                        numero: numeroLinha,
                        nome: getLineName(numeroLinha),
                        cor: CORES_LINHAS[numeroLinha],
                        coordinates: coordenadasLinha,
                        estacoes: estacoesLinha
                    };
                }
            });

            return linhasOrdenadas;
        }

        function drawDynamicLines() {
            console.log('🛤️ Desenhando linhas dinâmicas baseadas nas estações...');

            const linhasDinamicas = generateDynamicLines();

            Object.values(linhasDinamicas).forEach(linha => {
                if (linha.coordinates && linha.coordinates.length > 1) {
                    // Criar polilinha com estilo melhorado
                    const polyline = L.polyline(linha.coordinates, {
                        color: linha.cor,
                        weight: linha.numero === '11' ? 8 : 6, // Linha 11 mais destacada
                        opacity: linha.numero === '11' ? 0.9 : 0.8,
                        smoothFactor: 1,
                        className: `linha-${linha.numero}`,
                        lineCap: 'round',
                        lineJoin: 'round'
                    }).addTo(window.currentMap);

                    // Popup informativo rico
                    const isOficial = linha.numero === '11';
                    const popupContent = `
                        <div class="popup-content">
                            <h3 class="popup-title" style="color: ${linha.cor};">
                                🚇 Linha ${linha.numero} - ${linha.nome}
                                ${isOficial ? '<br><small style="color: #27ae60;">📍 Coordenadas Oficiais - Site CPTM</small>' : ''}
                            </h3>
                            <div style="margin: 10px 0;">
                                <p><strong>Estações:</strong> ${linha.estacoes.length}</p>
                                <p><strong>Status:</strong> <span class="status-operational">● Operacional</span></p>
                                ${isOficial ? '<p><strong>Precisão:</strong> <span style="color: #27ae60;">● Oficial</span></p>' : ''}
                            </div>
                            <div style="max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px;">
                                <strong>Trajeto:</strong><br>
                                ${linha.estacoes.map((est, i) =>
                        `<small>${i + 1}. ${est.nome}</small>`
                    ).join('<br>')}
                            </div>
                        </div>
                    `;

                    polyline.bindPopup(popupContent, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });

                    // Efeitos hover melhorados
                    polyline.on('mouseover', function (e) {
                        this.setStyle({
                            weight: 8,
                            opacity: 1
                        });
                    });

                    polyline.on('mouseout', function (e) {
                        this.setStyle({
                            weight: 6,
                            opacity: 0.8
                        });
                    });

                    // Armazenar referência
                    linha.polyline = polyline;

                    console.log(`✅ Linha ${linha.numero} criada com ${linha.estacoes.length} estações`);
                }
            });

            showNotification('🚇 Linhas dinâmicas geradas com sucesso!', 'success');

            // Notificação especial para Linha 11 com coordenadas oficiais
            setTimeout(() => {
                showNotification('🎯 Linha 11 - Coral atualizada com coordenadas OFICIAIS do site CPTM!', 'info');
            }, 2000);

            // Log detalhado das linhas criadas
            console.log('📊 Resumo das linhas dinâmicas criadas:');
            Object.values(linhasDinamicas).forEach(linha => {
                if (linha.numero === '11') {
                    console.log(`🎯 Linha ${linha.numero} (CORAL - COORDENADAS OFICIAIS SITE CPTM): ${linha.estacoes.length} estações conectadas`);
                    console.log('📍 Estações oficiais:', linha.estacoes.map(e => e.nome).join(' → '));
                    console.log('✅ Precisão: 100% oficial - Fonte: site CPTM');
                } else {
                    console.log(`🚇 Linha ${linha.numero}: ${linha.estacoes.length} estações conectadas`);
                }
            });
        }

        function drawLineTrajectories() {
            Object.values(lineTrajectories).forEach(linha => {
                if (linha.coordinates && linha.coordinates.length > 1) {
                    // Criar polilinha para o trajeto da linha
                    const trajectory = L.polyline(linha.coordinates, {
                        color: linha.cor,
                        weight: 4,
                        opacity: 0.7,
                        smoothFactor: 1
                    }).addTo(map);

                    // Adicionar popup informativo
                    trajectory.bindPopup(`
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: ${linha.cor};">
                                Linha ${linha.numero} - ${linha.nome}
                            </h3>
                            <p><strong>Estações:</strong> ${linha.estacoes.length}</p>
                            <p><strong>Status:</strong> <span style="color: #2ecc71;">● Operacional</span></p>
                        </div>
                    `);

                    // Armazenar referência da linha
                    linha.polyline = trajectory;
                }
            });
        }

        function addStationControlPoint(estacao) {
            // Validar se a estação tem coordenadas válidas
            if (!estacao || typeof estacao.latitude !== 'number' || typeof estacao.longitude !== 'number' ||
                isNaN(estacao.latitude) || isNaN(estacao.longitude)) {
                console.log('Não é possível adicionar estação com coordenadas inválidas:', estacao);
                return;
            }

            // Criar ícone melhorado para estação como ponto de controle
            const stationIcon = L.divIcon({
                html: `
                    <div class="station-control-point" style="
                        background-color: ${estacao.linha_cor || '#666'}; 
                        width: 18px; 
                        height: 18px; 
                        border-radius: 50%; 
                        border: 3px solid white; 
                        box-shadow: 0 3px 8px rgba(0,0,0,0.4);
                        position: relative;
                        animation: pulse 2s infinite;
                    ">
                        <div style="
                            position: absolute;
                            top: -25px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: white;
                            color: ${estacao.linha_cor || '#666'};
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-size: 10px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            display: none;
                        " class="station-label">
                            ${estacao.nome}
                        </div>
                    </div>
                `,
                className: 'custom-station-control',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            const marker = L.marker([estacao.latitude, estacao.longitude], {
                icon: stationIcon,
                title: estacao.nome
            }).addTo(markerLayer);

            // Mostrar/ocultar label ao passar o mouse
            marker.on('mouseover', function () {
                this.getElement().querySelector('.station-label').style.display = 'block';
            });

            marker.on('mouseout', function () {
                this.getElement().querySelector('.station-label').style.display = 'none';
            });

            // Popup melhorado para ponto de controle
            marker.bindPopup(`
                <div style="padding: 15px; max-width: 300px;">
                    <h3 style="margin: 0 0 15px 0; color: ${estacao.linha_cor || '#666'};">
                        🚉 ${estacao.nome}
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <strong>Linha:</strong><br>
                            <span style="color: ${estacao.linha_cor || '#666'};">
                                ${estacao.linha_numero || 'N/A'} - ${estacao.linha_nome || 'N/A'}
                            </span>
                        </div>
                        <div>
                            <strong>Ordem:</strong><br>
                            ${estacao.ordem || 'N/A'}ª estação
                        </div>
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <strong>Recursos:</strong><br>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            ${estacao.acessivel ? '<span style="color: #2ecc71;">♿ Acessível</span>' : '<span style="color: #e74c3c;">♿ Não acessível</span>'}
                            ${estacao.tem_elevador ? '<span style="color: #2ecc71;">🛗 Elevador</span>' : ''}
                            ${estacao.tem_escada_rolante ? '<span style="color: #2ecc71;">🔄 Escada rolante</span>' : ''}
                        </div>
                    </div>
                    
                    <button onclick="showStationSchedule(${estacao.id})" 
                            style="background: ${estacao.linha_cor || '#666'}; color: white; border: none; 
                                   padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;
                                   font-weight: 600; width: 100%;">
                        📅 Ver Horários e Previsões
                    </button>
                </div>
            `);

            // Armazenar ponto de controle
            stationControlPoints[estacao.id] = {
                marker: marker,
                estacao: estacao,
                isControlPoint: true
            };

            markers[estacao.id] = marker;
        }

        function updateTrainMarker(trem) {
            // Validar coordenadas
            if (!trem || typeof trem.latitude !== 'number' || typeof trem.longitude !== 'number' ||
                isNaN(trem.latitude) || isNaN(trem.longitude)) {
                console.log('Não é possível atualizar trem com coordenadas inválidas:', trem);
                return;
            }

            const existingMarker = trainMarkers[trem.id];

            if (existingMarker) {
                // Movimento suavizado para o trem
                const currentPos = existingMarker.getLatLng();
                const newPos = [trem.latitude, trem.longitude];

                // Criar animação suave de movimento
                animateTrainMovement(existingMarker, currentPos, newPos, trem);

                // Atualizar popup com informações mais detalhadas
                updateTrainPopup(existingMarker, trem);
            } else {
                // Criar novo marcador se não existir
                addTrainMarker(trem);
            }

            // Verificar se passou por ponto de controle
            checkControlPointPassage(trem);
        }

        function animateTrainMovement(marker, fromPos, toPos, trem) {
            const steps = 20; // Número de passos para a animação
            const latStep = (toPos[0] - fromPos.lat) / steps;
            const lngStep = (toPos[1] - fromPos.lng) / steps;
            let currentStep = 0;

            const animate = () => {
                if (currentStep < steps) {
                    currentStep++;
                    const newLat = fromPos.lat + (latStep * currentStep);
                    const newLng = fromPos.lng + (lngStep * currentStep);
                    marker.setLatLng([newLat, newLng]);

                    // Continuar animação
                    setTimeout(animate, 50); // 50ms entre passos = 1 segundo total
                }
            };

            animate();
        }

        function updateTrainPopup(marker, trem) {
            const statusColor = getStatusColor(trem.status);
            const lotacaoColor = getLotacaoColor(trem.lotacao);

            marker.bindPopup(`
                <div style="padding: 15px; max-width: 350px;">
                    <h3 style="margin: 0 0 15px 0; color: ${trem.linha_cor || '#3498db'};">
                        🚆 Trem ${trem.identificador}
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong>Linha:</strong><br>
                            <span style="color: ${trem.linha_cor || '#3498db'};">
                                ${trem.linha_nome || 'N/A'}
                            </span>
                        </div>
                        <div>
                            <strong>Velocidade:</strong><br>
                            <span style="color: ${trem.velocidade > 0 ? '#2ecc71' : '#e74c3c'};">
                                ${trem.velocidade || 0} km/h
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="margin-bottom: 8px;">
                            <strong>Status:</strong> <span style="color: ${statusColor};">● ${trem.status || 'N/A'}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Lotação:</strong> <span style="color: ${lotacaoColor};">● ${trem.lotacao || 'N/A'}</span>
                        </div>
                        <div>
                            <strong>Direção:</strong> ${trem.direcao || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="margin-bottom: 5px;">
                            <strong>📍 Estação atual:</strong> ${trem.estacao_atual || 'Em trânsito'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong>➡️ Próxima estação:</strong> ${trem.proxima_estacao || 'Indisponível'}
                        </div>
                        ${trem.previsao_chegada ? `
                            <div>
                                <strong>🕐 Previsão:</strong> ${formatTime(trem.previsao_chegada)}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="font-size: 12px; color: #666; text-align: center;">
                        Última atualização: ${formatTime(trem.ultima_atualizacao)}
                    </div>
                </div>
            `);
        }

        function checkControlPointPassage(trem) {
            // Verificar se o trem passou por algum ponto de controle (estação)
            Object.values(stationControlPoints).forEach(controlPoint => {
                const station = controlPoint.estacao;

                // Calcular distância entre trem e estação
                const distance = calculateDistance(
                    trem.latitude, trem.longitude,
                    station.latitude, station.longitude
                );

                // Se está muito próximo (menos de 100 metros), considera que passou pelo ponto
                if (distance < 0.1) { // 0.1 km = 100 metros
                    triggerControlPointEvent(trem, station);
                }
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Fórmula de Haversine para calcular distância entre dois pontos
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function triggerControlPointEvent(trem, station) {
            // Criar efeito visual no ponto de controle
            const controlPoint = stationControlPoints[station.id];
            if (controlPoint && controlPoint.marker) {
                // Adicionar efeito de pulsação temporário
                const element = controlPoint.marker.getElement();
                if (element) {
                    element.style.animation = 'none';
                    setTimeout(() => {
                        element.style.animation = 'pulse 0.5s ease-in-out 3';
                    }, 10);
                }

                // Log do evento para debuging
                console.log(`🚆 Trem ${trem.identificador} passou pela estação ${station.nome}`);

                // Opcional: mostrar notificação
                if (Math.random() < 0.3) { // 30% de chance de mostrar notificação
                    showNotification(
                        `Trem ${trem.identificador} chegou em ${station.nome}`,
                        'info'
                    );
                }
            }
        }

        // ========== FUNÇÕES DE FOCO E INTERAÇÃO MELHORADAS ==========

        function focusOnLine(lineNumber) {
            console.log(`🎯 focusOnLine (Leaflet avançado) chamado para linha: ${lineNumber}`);

            const line = lineTrajectories[lineNumber];
            if (line && line.coordinates && line.coordinates.length > 0) {
                // Criar bounds incluindo todas as estações da linha
                const group = new L.featureGroup();
                line.coordinates.forEach(coord => {
                    L.marker(coord).addTo(group);
                });

                // Ajustar mapa para mostrar toda a linha
                map.fitBounds(group.getBounds().pad(0.1));

                // Destacar linha temporariamente
                if (line.polyline) {
                    const originalWeight = line.polyline.options.weight;
                    const originalOpacity = line.polyline.options.opacity;

                    line.polyline.setStyle({
                        weight: 8,
                        opacity: 1
                    });

                    // Restaurar após 2 segundos
                    setTimeout(() => {
                        line.polyline.setStyle({
                            weight: originalWeight,
                            opacity: originalOpacity
                        });
                    }, 2000);
                }

                // Funcionalidade especial para Linha 11 - Coral
                if (lineNumber === '11') {
                    console.log(`🚊 Iniciando simulação para Linha 11-Coral`);
                    showNotification(`🚊 Iniciando simulação em tempo real da ${getLineName(lineNumber)}`, 'success');
                    startLine11RealTimeSimulation();
                } else {
                    showNotification(`Focalizando Linha ${lineNumber} - ${line.nome}`, 'info');
                }
            } else {
                console.warn(`⚠️ Linha ${lineNumber} não encontrada em lineTrajectories`);

                // Fallback: focar nas estações da linha usando ESTACOES_CPTM
                const stationsOfLine = Object.entries(ESTACOES_CPTM || {})
                    .filter(([nome, dados]) => dados.linha === lineNumber)
                    .map(([nome, dados]) => [dados.lat, dados.lng]);

                if (stationsOfLine.length > 0) {
                    console.log(`🚉 Fallback: Focando em ${stationsOfLine.length} estações da linha ${lineNumber}`);
                    const group = new L.featureGroup();
                    stationsOfLine.forEach(coord => {
                        L.marker(coord).addTo(group);
                    });
                    map.fitBounds(group.getBounds().pad(0.1));

                    // Funcionalidade especial para Linha 11 - Coral
                    if (lineNumber === '11') {
                        console.log(`🚊 Iniciando simulação para Linha 11-Coral via fallback`);
                        showNotification(`🚊 Iniciando simulação em tempo real da ${getLineName(lineNumber)}`, 'success');
                        startLine11RealTimeSimulation();
                    } else {
                        showNotification(`Focalizando ${getLineName(lineNumber)}`, 'info');
                    }
                } else {
                    showNotification(`Erro: Linha ${lineNumber} não encontrada`, 'error');
                }
            }
        }

        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        }
    </script>

    <!-- Overlay Mobile -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3>Carregando CPTM Tracker</h3>
            <p>Conectando com a rede ferroviária...</p>
        </div>
    </div>

    <!-- Modal de Configuração do Google Maps -->
    <div id="googleMapsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🗺️ Escolher Provedor de Mapa</h3>
                <button onclick="closeGoogleMapsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: #e8f5e8; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #22c55e;">
                    <h4 style="margin: 0 0 8px 0; color: #16a34a;">🆓 Recomendado: OpenStreetMap (100% Gratuito)</h4>
                    <p style="margin: 0; color: #15803d;">
                        ✅ Completamente gratuito<br>
                        ✅ Sem limites de uso<br>
                        ✅ Dados atualizados pela comunidade<br>
                        ✅ Funciona perfeitamente para CPTM
                    </p>
                </div>

                <div
                    style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin: 0 0 8px 0; color: #d97706;">💰 Google Maps (Pago)</h4>
                    <p style="margin: 0 0 12px 0; color: #92400e;">
                        Requer chave de API válida e pode gerar custos.
                    </p>
                    <details>
                        <summary style="cursor: pointer; font-weight: 500;">Como obter chave do Google Maps</summary>
                        <ol style="margin: 12px 0 0 20px; color: #92400e;">
                            <li>Acesse <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                                    rel="noopener">Google Cloud Console</a></li>
                            <li>Crie um novo projeto</li>
                            <li>Ative a API "Maps JavaScript API"</li>
                            <li>Crie uma credencial "API Key"</li>
                            <li>Configure billing (cartão de crédito)</li>
                        </ol>
                    </details>
                    <div class="input-group" style="margin-top: 16px;">
                        <label for="googleMapsApiKey">Chave da API (opcional):</label>
                        <input type="text" id="googleMapsApiKey" placeholder="AIzaSy..."
                            style="width: 100%; padding: 12px; border: 1px solid #d97706; border-radius: 8px; margin-top: 8px;">
                    </div>
                </div>

                <div class="modal-actions">
                    <button onclick="useLeafletInstead()" class="btn-primary"
                        style="background: #22c55e; border-color: #22c55e;">
                        🆓 Usar OpenStreetMap (Gratuito)
                    </button>
                    <button onclick="saveGoogleMapsKey()" class="btn-secondary">
                        💰 Usar Google Maps (Pago)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script>
        // Fallback para caso a API do Google Maps falhe
        function initMapFallback() {
            console.log('🗺️ Inicializando mapa com OpenStreetMap (fallback)...');

            // Usar Leaflet como fallback
            const leafletScript = document.createElement('script');
            leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            leafletScript.onload = function () {
                const leafletCSS = document.createElement('link');
                leafletCSS.rel = 'stylesheet';
                leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(leafletCSS);

                setTimeout(initLeafletMap, 500);
            };
            document.head.appendChild(leafletScript);
        }

        function initLeafletMap() {
            console.log('🍃 Inicializando Leaflet com recursos avançados...');

            // Verificar se o mapa já foi inicializado
            if (map && map.remove) {
                console.log('🍃 Mapa Leaflet já inicializado, removendo instância anterior...');
                map.remove();
            }

            // Criar mapa com Leaflet
            map = L.map('map', {
                center: [-23.5505, -46.6333],
                zoom: 11,
                zoomControl: false,
                attributionControl: true
            });

            // Camadas de mapa múltiplas (gratuitas)
            const layers = {
                'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }),
                'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '© Esri © DigitalGlobe © GeoEye © Earthstar Geographics'
                }),
                'Dark Mode': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© OpenStreetMap contributors © CARTO'
                }),
                'Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors © OpenTopoMap'
                })
            };

            // Adicionar camada padrão
            window.baseLayer = layers['OpenStreetMap'];
            window.baseLayer.addTo(map);

            // Controle de camadas
            const layerControl = L.control.layers(layers).addTo(map);

            // Controle de zoom customizado
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Adicionar escala
            L.control.scale({
                position: 'bottomleft',
                imperial: false
            }).addTo(map);

            // Adicionar estações com estilo avançado
            addStationsLeaflet();

            // Adicionar linhas das rotas
            // Usar sistema dinâmico de linhas baseado nas estações
            try {
                if (typeof generateDynamicLines === 'function') {
                    drawDynamicLines();
                } else {
                    console.warn('⚠️ generateDynamicLines não está disponível ainda');
                }
            } catch (error) {
                console.error('⚠️ Erro ao desenhar linhas dinâmicas:', error);
            }

            // Adicionar trens
            addTrainsLeaflet();

            // Adicionar controles personalizados
            addLeafletCustomControls();

            console.log('✅ Leaflet inicializado com recursos premium (gratuito)!');
        }

        function addRouteLinesLeaflet() {
            console.log('🛤️ Adicionando rotas das linhas CPTM...');

            const linhas = {
                '7': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '7').map(([nome, dados]) => [dados.lat, dados.lng]),
                '8': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '8').map(([nome, dados]) => [dados.lat, dados.lng]),
                '9': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '9').map(([nome, dados]) => [dados.lat, dados.lng]),
                '10': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '10').map(([nome, dados]) => [dados.lat, dados.lng]),
                '11': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '11').map(([nome, dados]) => [dados.lat, dados.lng]),
                '12': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '12').map(([nome, dados]) => [dados.lat, dados.lng]),
                '13': Object.entries(ESTACOES_CPTM).filter(([nome, dados]) => dados.linha === '13').map(([nome, dados]) => [dados.lat, dados.lng])
            };

            Object.entries(linhas).forEach(([numeroLinha, coordenadas]) => {
                if (coordenadas.length > 1) {
                    const polyline = L.polyline(coordenadas, {
                        color: CORES_LINHAS[numeroLinha],
                        weight: 6,
                        opacity: 0.8,
                        smoothFactor: 1,
                        className: `linha-${numeroLinha}`
                    }).addTo(map);

                    polyline.bindPopup(`
                        <div class="popup-content">
                            <h3 style="color: ${CORES_LINHAS[numeroLinha]};">${getLineName(numeroLinha)}</h3>
                            <p><strong>Estações:</strong> ${coordenadas.length}</p>
                            <p><strong>Status:</strong> <span style="color: #22c55e;">● Operacional</span></p>
                        </div>
                    `);

                    linePolylines[numeroLinha] = polyline;
                }
            });
        }

        function addLeafletCustomControls() {
            // Controle personalizado para centralizar mapa
            const centerControl = L.Control.extend({
                onAdd: function (map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.width = '40px';
                    container.style.height = '40px';
                    container.style.cursor = 'pointer';
                    container.innerHTML = '<i class="fas fa-crosshairs" style="line-height: 40px; text-align: center; width: 100%; display: block;"></i>';
                    container.onclick = function () {
                        map.setView([-23.5505, -46.6333], 11);
                        showNotification('Mapa centralizado', 'info');
                    };
                    return container;
                }
            });

            map.addControl(new centerControl({ position: 'topright' }));

            // Controle de localização (se disponível)
            if (navigator.geolocation) {
                const locationControl = L.Control.extend({
                    onAdd: function (map) {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                        container.style.backgroundColor = 'white';
                        container.style.width = '40px';
                        container.style.height = '40px';
                        container.style.cursor = 'pointer';
                        container.innerHTML = '<i class="fas fa-location-arrow" style="line-height: 40px; text-align: center; width: 100%; display: block;"></i>';
                        container.onclick = function () {
                            navigator.geolocation.getCurrentPosition(function (position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                map.setView([lat, lng], 15);
                                L.marker([lat, lng]).addTo(map)
                                    .bindPopup('Sua localização')
                                    .openPopup();
                                showNotification('Localização encontrada!', 'success');
                            }, function () {
                                showNotification('Erro ao obter localização', 'error');
                            });
                        };
                        return container;
                    }
                });

                map.addControl(new locationControl({ position: 'topright' }));
            }
        }

        function addStationsLeaflet() {
            console.log('🚉 Adicionando estações com design avançado...');

            // Armazenar estações globalmente para busca de proximidade
            window.estacoes = [];

            Object.entries(ESTACOES_CPTM).forEach(([nome, dados]) => {
                // Criar ícone customizado para estação
                const stationIcon = L.divIcon({
                    className: 'custom-station-icon',
                    html: `
                        <div style="
                            background: ${dados.cor};
                            width: 16px;
                            height: 16px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
                            position: relative;
                            z-index: 100;
                        ">
                            <div style="
                                position: absolute;
                                top: -2px;
                                left: -2px;
                                width: 20px;
                                height: 20px;
                                border-radius: 50%;
                                background: ${dados.cor}40;
                                animation: pulse 2s infinite;
                            "></div>
                        </div>
                    `,
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                });

                const marker = L.marker([dados.lat, dados.lng], {
                    icon: stationIcon,
                    zIndexOffset: 100
                }).addTo(map);

                // Popup rico com informações
                const popupContent = `
                    <div class="popup-content" style="min-width: 250px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="
                                width: 12px; 
                                height: 12px; 
                                background: ${dados.cor}; 
                                border-radius: 50%; 
                                margin-right: 8px;
                            "></div>
                            <h3 style="margin: 0; color: ${dados.cor}; font-weight: 600;">
                                🚉 ${nome}
                            </h3>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                                <div><strong>Linha:</strong> ${dados.linha}</div>
                                <div><strong>Zona:</strong> ${getZone(dados.lat, dados.lng)}</div>
                            </div>
                            <div style="margin-top: 8px; font-size: 14px;">
                                <strong>Nome completo:</strong> ${getLineName(dados.linha)}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <span style="
                                background: #22c55e; 
                                color: white; 
                                padding: 4px 8px; 
                                border-radius: 12px; 
                                font-size: 12px; 
                                font-weight: 500;
                            ">● Operacional</span>
                            <span style="
                                background: #3b82f6; 
                                color: white; 
                                padding: 4px 8px; 
                                border-radius: 12px; 
                                font-size: 12px;
                            ">♿ Acessível</span>
                        </div>
                        
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                            <div style="font-size: 12px; color: #6b7280;">
                                <div>📍 Lat: ${dados.lat.toFixed(6)}</div>
                                <div>📍 Lng: ${dados.lng.toFixed(6)}</div>
                            </div>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });

                // Adicionar efeito hover
                marker.on('mouseover', function () {
                    this.openPopup();
                });

                // Armazenar estação no array global
                window.estacoes.push({
                    id: nome.replace(/\s+/g, '_'),
                    nome: nome,
                    latitude: dados.lat,
                    longitude: dados.lng,
                    linha_cor: dados.cor,
                    linha_nome: getLineName(dados.linha),
                    zona: getZone(dados.lat, dados.lng)
                });

                // Armazenar referência do marcador
                if (!window.stationMarkers) window.stationMarkers = {};
                window.stationMarkers[nome.replace(/\s+/g, '_')] = marker;

                markers[nome] = marker;
            });

            console.log(`✅ ${Object.keys(markers).length} estações adicionadas com design premium`);
        }

        function getZone(lat, lng) {
            // Determinar zona da cidade baseada na coordenada
            if (lat > -23.5 && lng > -46.6) return 'Norte';
            if (lat > -23.5 && lng < -46.6) return 'Oeste';
            if (lat < -23.5 && lng > -46.6) return 'Leste';
            return 'Sul';
        }

        function addTrainsLeaflet() {
            if (trens && Array.isArray(trens)) {
                trens.forEach(trem => {
                    if (trem && typeof trem.latitude === 'number' && typeof trem.longitude === 'number' &&
                        !isNaN(trem.latitude) && !isNaN(trem.longitude)) {

                        const cor = CORES_LINHAS[trem.linha] || '#3498db';

                        const trainIcon = L.divIcon({
                            className: 'train-marker-leaflet',
                            html: `<div style="background: ${cor}; color: white; width: 20px; height: 20px; border-radius: 4px; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">🚆</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });

                        const marker = L.marker([trem.latitude, trem.longitude], {
                            icon: trainIcon
                        }).addTo(map);

                        marker.bindPopup(`
                            <div class="popup-content">
                                <h3 style="color: ${cor};">🚆 Trem ${trem.identificador}</h3>
                                <p><strong>Linha:</strong> ${trem.linha_nome || 'N/A'}</p>
                                <p><strong>Velocidade:</strong> ${trem.velocidade || 0} km/h</p>
                                <p><strong>Status:</strong> ${trem.status || 'N/A'}</p>
                            </div>
                        `);

                        trainMarkers[trem.id] = marker;
                    }
                });
            }
        }

        // ========== MODAL DE CONFIGURAÇÃO DO GOOGLE MAPS ==========
        function showGoogleMapsModal() {
            const modal = document.getElementById('googleMapsModal');
            modal.classList.add('show');
        }

        function closeGoogleMapsModal() {
            const modal = document.getElementById('googleMapsModal');
            modal.classList.remove('show');
        }

        function saveGoogleMapsKey() {
            const apiKey = document.getElementById('googleMapsApiKey').value.trim();

            if (!apiKey) {
                alert('Por favor, insira uma chave de API válida.');
                return;
            }

            // Salvar no localStorage
            localStorage.setItem('googleMapsApiKey', apiKey);

            // Fechar modal
            closeGoogleMapsModal();

            // Carregar Google Maps com a chave fornecida
            loadGoogleMapsWithKey(apiKey);
        }

        function useLeafletInstead() {
            closeGoogleMapsModal();
            console.log('🗺️ Usuário escolheu usar Leaflet');
            localStorage.setItem('mapPreference', 'leaflet');
            initMapFallback();
        }

        function toggleMapProvider() {
            const currentProvider = localStorage.getItem('mapPreference') || 'google';

            if (currentProvider === 'google') {
                // Mudar para Leaflet
                localStorage.setItem('mapPreference', 'leaflet');
                showNotification('Mudando para OpenStreetMap...', 'info');
                location.reload(); // Recarregar página para aplicar mudança
            } else {
                // Mudar para Google Maps
                localStorage.removeItem('mapPreference');
                showNotification('Mudando para Google Maps...', 'info');
                showGoogleMapsModal();
            }
        }

        function loadGoogleMapsWithKey(apiKey) {
            console.log('🗺️ Carregando Google Maps com chave fornecida...');

            showLoading();

            // Detectar erro da API e usar fallback automaticamente
            window.gm_authFailure = function () {
                console.warn('⚠️ Falha na autenticação do Google Maps - chave inválida');
                hideLoading();
                alert('Chave de API inválida. Usando OpenStreetMap como alternativa.');
                initMapFallback();
            };

            // Timeout para fallback automático
            const timeout = setTimeout(() => {
                console.warn('⚠️ Timeout do Google Maps - usando fallback');
                hideLoading();
                initMapFallback();
            }, 15000); // 15 segundos

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry`;

            script.onload = function () {
                clearTimeout(timeout);
                console.log('✅ Google Maps carregado com sucesso!');
                hideLoading();
            };

            script.onerror = function (error) {
                clearTimeout(timeout);
                console.warn('⚠️ Erro ao carregar Google Maps:', error);
                hideLoading();
                alert('Erro ao carregar Google Maps. Usando OpenStreetMap como alternativa.');
                initMapFallback();
            };

            document.head.appendChild(script);
        }

        // Carregar Google Maps ou mostrar modal
        function loadGoogleMaps() {
            console.log('🗺️ Usando soluções gratuitas...');

            // Verificar preferência do usuário - padrão será Leaflet (gratuito)
            const mapPreference = localStorage.getItem('mapPreference') || 'leaflet';

            if (mapPreference === 'leaflet') {
                console.log('🍃 Usando OpenStreetMap (100% gratuito)');
                initMapFallback();
                return;
            }

            // Verificar se há chave salva para Google Maps (opcional)
            const savedApiKey = localStorage.getItem('googleMapsApiKey');
            if (savedApiKey) {
                console.log('🗺️ Tentando usar Google Maps com chave salva');
                loadGoogleMapsWithKey(savedApiKey);
            } else {
                console.log('🍃 Usando OpenStreetMap como padrão (gratuito)');
                initMapFallback();
            }
        }

        // === FUNCIONALIDADES DE LOCALIZAÇÃO ===

        // Função para localizar usuário
        window.locateUser = function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Remover marker anterior se existir
                    if (window.userLocationMarker) {
                        window.currentMap.removeLayer(window.userLocationMarker);
                    }
                    if (window.userAccuracyCircle) {
                        window.currentMap.removeLayer(window.userAccuracyCircle);
                    }

                    // Criar marker de localização
                    const userIcon = L.divIcon({
                        html: '<div class="user-location-marker" style="background: #4A90E2; color: white; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;">📍</div>',
                        className: 'custom-user-marker',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });

                    window.userLocationMarker = L.marker([lat, lng], {
                        icon: userIcon,
                        title: 'Sua localização'
                    }).addTo(window.currentMap);

                    // Adicionar círculo de precisão
                    window.userAccuracyCircle = L.circle([lat, lng], {
                        radius: accuracy,
                        color: '#4A90E2',
                        fillColor: '#4A90E2',
                        fillOpacity: 0.1,
                        weight: 2
                    }).addTo(window.currentMap);

                    // Popup com informações
                    window.userLocationMarker.bindPopup(`
                        <div class="popup-content">
                            <h3 class="popup-title" style="color: #4A90E2;">📍 Sua Localização</h3>
                            <p><strong>Precisão:</strong> ±${Math.round(accuracy)}m</p>
                            <p><strong>Encontrar estações próximas?</strong></p>
                            <button class="popup-button" onclick="findNearbyStations(${lat}, ${lng})">
                                🔍 Buscar Estações
                            </button>
                        </div>
                    `);

                    // Centrar mapa na localização
                    window.currentMap.setView([lat, lng], 15);

                    // Mostrar notificação
                    showNotification('📍 Localização encontrada!', 'success');

                }, function (error) {
                    let message = 'Erro ao obter localização';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Permissão de localização negada';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Localização indisponível';
                            break;
                        case error.TIMEOUT:
                            message = 'Timeout ao obter localização';
                            break;
                    }
                    showNotification(`❌ ${message}`, 'error');
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutos
                });
            } else {
                showNotification('❌ Geolocalização não suportada', 'error');
            }
        };

        // Função para encontrar estações próximas
        window.findNearbyStations = function (userLat, userLng) {
            if (!window.estacoes) return;

            // Calcular distâncias
            const nearbyStations = window.estacoes.map(estacao => {
                const distance = calculateDistance(userLat, userLng, estacao.latitude, estacao.longitude);
                return { ...estacao, distance };
            }).filter(estacao => estacao.distance <= 2000) // 2km de raio
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5); // Máximo 5 estações

            if (nearbyStations.length === 0) {
                showNotification('ℹ️ Nenhuma estação encontrada nas proximidades', 'info');
                return;
            }

            // Destacar estações próximas no mapa
            nearbyStations.forEach((estacao, index) => {
                setTimeout(() => {
                    const marker = window.stationMarkers[estacao.id];
                    if (marker) {
                        // Animação de destaque
                        const element = marker.getElement();
                        if (element) {
                            element.style.animation = 'pulse 1s ease-in-out 3';
                        }
                    }
                }, index * 300);
            });

            // Mostrar popup com estações próximas
            const stationsHtml = nearbyStations.map(estacao =>
                `<div style="margin-bottom: 8px; padding: 5px; border-left: 3px solid ${estacao.linha_cor};">
                    <strong>${estacao.nome}</strong><br>
                    <small>${estacao.linha_nome} • ${estacao.distance.toFixed(0)}m</small>
                </div>`
            ).join('');

            const popup = L.popup()
                .setLatLng([userLat, userLng])
                .setContent(`
                    <div class="popup-content">
                        <h3 class="popup-title" style="color: #4A90E2;">🚇 Estações Próximas</h3>
                        ${stationsHtml}
                        <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                            💡 As estações destacadas no mapa são as mais próximas
                        </p>
                    </div>
                `)
                .openOn(window.currentMap);

            showNotification(`🎯 ${nearbyStations.length} estação(ões) encontrada(s)`, 'success');
        };

        // Função auxiliar para calcular distância
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 1000; // Retorna em metros
        }

        // === FIM DAS FUNCIONALIDADES DE LOCALIZAÇÃO ===

        // Executar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLeafletOnly);
        } else {
            initializeLeafletOnly();
        }

        function initializeLeafletOnly() {
            // Carregar Leaflet e inicializar mapa
            if (typeof L !== 'undefined') {
                initLeafletMap();
            } else {
                const leafletScript = document.createElement('script');
                leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletScript.onload = () => initLeafletMap();
                document.head.appendChild(leafletScript);
            }
        }
    </script>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>

</html>